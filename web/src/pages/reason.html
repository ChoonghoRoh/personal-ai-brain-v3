<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="/static/css/reason.css" />
    <link rel="stylesheet" href="/static/css/reason-sections.css" />
    <link rel="stylesheet" href="/static/css/reason-advanced.css" />
    <title>Personal AI Brain - Reasoning Lab</title>
  </head>
  <body>
    <div class="container">
      <!-- Header는 JavaScript로 동적 생성 -->
      <!-- Phase 10-3-4: 다크 모드 토글 -->
      <button type="button" class="theme-toggle" id="theme-toggle-btn" onclick="toggleDarkMode()" aria-label="테마 전환" title="다크/라이트 모드 전환">
        <span class="theme-toggle-icon" id="theme-icon">
          <svg class="icon-sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5" />
            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
          </svg>
          <svg class="icon-moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
          </svg>
        </span>
      </button>

      <div class="reasoning-form">
        <h2>Reasoning 설정</h2>
        <form
          id="reasoning-form"
          onsubmit="
            runReasoning(event);
            return false;
          "
        >
          <!-- 1. 질문/지시사항 우선 (LLM·의미 검색 기반) -->
          <div class="form-group form-group-primary">
            <label for="question">질문 또는 지시사항</label>
            <textarea id="question" placeholder="예: 다음에 뭐하면 좋을까? 설계 배경을 설명해줘." aria-describedby="question-hint"></textarea>
            <small class="form-hint" id="question-hint">질문/지시를 우선 분석해 관련 청크를 찾고, Reasoning 모드에 맞춰 청크 기반으로 설명합니다.</small>
          </div>

          <div class="form-group">
            <label for="mode">Reasoning 모드</label>
            <select id="mode" required aria-describedby="mode-description">
              <option value="design_explain">📐 설계/배경 설명 (Design Explain)</option>
              <option value="risk_review">⚠️ 리스크 분석 (Risk Review)</option>
              <option value="next_steps">🚀 다음 단계 제안 (Next Steps)</option>
              <option value="history_trace">📜 히스토리/맥락 추적 (History Trace)</option>
            </select>
            <small class="form-hint">
              <span id="mode-description">각 모드의 용도를 선택하세요</span>
            </small>
          </div>

          <div class="form-group">
            <label for="reason-model">LLM 모델 (Reasoning·추천에 사용)</label>
            <select id="reason-model" aria-describedby="model-hint">
              <option value="">기본 (env 기본)</option>
            </select>
            <small class="form-hint" id="model-hint"> 비우면 .env 기본 모델 사용. 설치된 Ollama 모델은 페이지 로드 시 목록에 표시됩니다. </small>
          </div>

          <!-- 보조: 프로젝트/라벨 조회·선택 (선택 시 질문 결과와 병합) -->
          <div class="form-section form-section-auxiliary">
            <h3 class="form-section-title">보조 조회 (선택)</h3>
            <p class="form-section-desc">프로젝트·라벨을 선택하면 해당 청크를 질문 결과와 함께 사용합니다. 직접 입력도 가능합니다.</p>
            <div class="form-row">
              <div class="form-group">
                <label for="projects-select">프로젝트</label>
                <select id="projects-select" multiple size="3" title="Ctrl/Cmd로 다중 선택" aria-label="프로젝트 선택">
                  <!-- /api/knowledge/projects 로 채움 -->
                </select>
                <input type="text" id="projects" class="input-fallback" placeholder="직접 입력: 예) 1, 3" />
              </div>
              <div class="form-group">
                <label for="labels-select">라벨</label>
                <select id="labels-select" multiple size="3" title="Ctrl/Cmd로 다중 선택" aria-label="라벨 선택">
                  <!-- /api/labels 로 채움 -->
                </select>
                <input type="text" id="labels" class="input-fallback" placeholder="직접 입력: 예) ai, architecture" />
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="submit-btn">🚀 Reasoning 실행</button>
            <button type="button" class="btn btn-secondary btn-cancel" id="cancel-btn" style="display: none">❌ 취소</button>
          </div>
        </form>
      </div>

      <div id="error-message" class="error" role="alert" style="display: none"></div>

      <div id="results" class="results" style="display: none" aria-label="Reasoning 결과">
        <!-- 진행 상태 영역 (Phase 10-1-1: 5단계 실시간 표시) -->
        <div id="results-loading" class="results-loading" style="display: none" role="status" aria-live="polite">
          <!-- 예상 소요 시간 (Phase 10-1-3) -->
          <div id="eta-display" class="eta-display" aria-label="예상 소요 시간">
            <span class="eta-icon" aria-hidden="true">⏱️</span>
            <span id="eta-text">예상 소요 시간을 계산 중...</span>
          </div>

          <!-- 5단계 진행 인디케이터 -->
          <div class="progress-stages" id="progress-stages" role="group" aria-label="Reasoning 진행 단계">
            <div class="progress-stage" data-stage="1" aria-label="1단계: 질문 분석">
              <div class="stage-icon" aria-hidden="true">1</div>
              <div class="stage-label">질문 분석</div>
            </div>
            <div class="progress-connector" aria-hidden="true"></div>
            <div class="progress-stage" data-stage="2" aria-label="2단계: 문서 검색">
              <div class="stage-icon" aria-hidden="true">2</div>
              <div class="stage-label">문서 검색</div>
            </div>
            <div class="progress-connector" aria-hidden="true"></div>
            <div class="progress-stage" data-stage="3" aria-label="3단계: 지식 확장">
              <div class="stage-icon" aria-hidden="true">3</div>
              <div class="stage-label">지식 확장</div>
            </div>
            <div class="progress-connector" aria-hidden="true"></div>
            <div class="progress-stage" data-stage="4" aria-label="4단계: AI 추론">
              <div class="stage-icon" aria-hidden="true">4</div>
              <div class="stage-label">AI 추론</div>
            </div>
            <div class="progress-connector" aria-hidden="true"></div>
            <div class="progress-stage" data-stage="5" aria-label="5단계: 추천 생성">
              <div class="stage-icon" aria-hidden="true">5</div>
              <div class="stage-label">추천 생성</div>
            </div>
          </div>

          <!-- 진행률 바 -->
          <div class="progress-bar-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Reasoning 진행률">
            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
          </div>

          <!-- 현재 단계 메시지 -->
          <p class="reasoning-loading-main" id="progress-message" aria-live="polite">⏳ Reasoning 준비 중...</p>
          <p class="reasoning-loading-elapsed" id="reasoning-elapsed-text" aria-live="off">잠시만 기다려주세요...</p>
        </div>
        <!-- 결과 영역 (API 응답 후 표시) — Phase 10-3-1: 공통 결과 구조 (요약/상세/시각화/인사이트) -->
        <div id="results-content" class="results-content" style="display: none">
          <!-- Phase 10-3-3/10-4: 결과 툴바 -->
          <div class="results-toolbar">
            <button type="button" class="btn btn-export" id="export-pdf-btn" onclick="exportResultsPDF()" aria-label="결과를 PDF로 내보내기">PDF 내보내기</button>
            <button type="button" class="btn btn-export btn-share" id="share-btn" onclick="shareResult()" aria-label="결과 공유 URL 생성">공유</button>
            <button type="button" class="btn btn-export btn-save-decision" id="save-decision-btn" onclick="showSaveDecisionModal()" aria-label="의사결정 문서로 저장">저장</button>
          </div>

          <!-- ① 요약 (Summary) -->
          <div class="result-section result-section-summary" role="region" aria-label="결과 요약">
            <h3 class="section-header"><span class="section-badge">1</span> 요약</h3>
            <div id="result-summary-text" class="summary-brief"></div>
            <div id="result-summary" class="summary-box">
              <div class="summary-item">
                <span class="summary-label">참고 문서 수:</span>
                <span id="summary-docs-count" class="summary-value">-</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">사용된 지식 청크:</span>
                <span id="summary-chunks-count" class="summary-value">-</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">발견된 관계:</span>
                <span id="summary-relations-count" class="summary-value">-</span>
              </div>
            </div>
          </div>

          <!-- ② 시각화 (Visualization) -->
          <div id="mode-viz-container" class="result-section result-section-viz mode-viz-container" style="display: none" role="region" aria-label="시각화">
            <h3 id="mode-viz-title" class="section-header mode-viz-title"><span class="section-badge">2</span></h3>
            <div id="viz-design-explain" class="mode-viz-panel" data-mode="design_explain" style="display: none"></div>
            <div id="viz-risk-review" class="mode-viz-panel" data-mode="risk_review" style="display: none"></div>
            <div id="viz-next-steps" class="mode-viz-panel" data-mode="next_steps" style="display: none"></div>
            <div id="viz-history-trace" class="mode-viz-panel" data-mode="history_trace" style="display: none"></div>
          </div>

          <!-- ③ 상세 (Detail) -->
          <div class="result-section result-section-detail" role="region" aria-label="상세 분석">
            <h3 class="section-header"><span class="section-badge">3</span> 상세 분석</h3>
            <div id="answer" class="answer-box"></div>

            <details class="detail-collapsible" open>
              <summary class="detail-toggle">사용된 컨텍스트</summary>
              <div class="detail-body">
                <div class="context-tabs" role="tablist">
                  <button class="tab-btn active" role="tab" aria-selected="true" onclick="switchContextTab('chunks')">청크 목록</button>
                  <button class="tab-btn" role="tab" aria-selected="false" onclick="switchContextTab('documents')">문서 목록</button>
                </div>
                <div id="context-chunks" class="context-content active" role="tabpanel"></div>
                <div id="context-documents" class="context-content" role="tabpanel"></div>
              </div>
            </details>

            <details class="detail-collapsible">
              <summary class="detail-toggle">Reasoning 단계</summary>
              <div class="detail-body">
                <div id="reasoning-steps" class="reasoning-steps"></div>
              </div>
            </details>
          </div>

          <!-- ④ 인사이트 (Insights) -->
          <div id="recommendations-section" class="result-section result-section-insight recommendations-section" style="display: none" role="region" aria-label="인사이트 및 추천">
            <h3 class="section-header"><span class="section-badge">4</span> 인사이트 & 추천</h3>
            <div class="recommendations-toggles" role="tablist">
              <button type="button" class="rec-toggle active" role="tab" aria-selected="true" data-panel="related-chunks">관련 청크</button>
              <button type="button" class="rec-toggle" role="tab" aria-selected="false" data-panel="sample-questions">샘플 질문</button>
              <button type="button" class="rec-toggle" role="tab" aria-selected="false" data-panel="suggested-labels">추천 라벨</button>
              <button type="button" class="rec-toggle" role="tab" aria-selected="false" data-panel="explore-more">추가 탐색</button>
            </div>
            <div id="related-chunks-panel" class="rec-panel active" role="tabpanel">
              <div id="related-chunks" class="recommendation-cards"></div>
            </div>
            <div id="sample-questions-panel" class="rec-panel" role="tabpanel">
              <div id="sample-questions" class="sample-questions-list"></div>
            </div>
            <div id="suggested-labels-panel" class="rec-panel" role="tabpanel">
              <div id="suggested-labels" class="label-tags"></div>
            </div>
            <div id="explore-more-panel" class="rec-panel" role="tabpanel">
              <div id="explore-more" class="explore-list"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Phase 10-4-2: 공유 알림 -->
    <div id="share-toast" class="share-toast" style="display: none" role="status" aria-live="polite"></div>

    <!-- Phase 10-4-3: 의사결정 저장 모달 -->
    <div id="save-decision-modal" class="modal-overlay" style="display: none" role="dialog" aria-modal="true" aria-label="의사결정 문서 저장">
      <div class="modal-content">
        <h3>의사결정 문서 저장</h3>
        <div class="form-group">
          <label for="decision-title">제목 <span style="color: #dc2626">*</span></label>
          <input type="text" id="decision-title" placeholder="예: API 설계 방향 결정" required />
        </div>
        <div class="form-group">
          <label for="decision-summary">요약 (선택)</label>
          <textarea id="decision-summary" rows="3" placeholder="간단한 요약을 입력하세요"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-primary" onclick="saveDecision()">저장</button>
          <button type="button" class="btn btn-secondary" onclick="closeSaveDecisionModal()">취소</button>
        </div>
      </div>
    </div>

    <!-- Phase 10-4-3: 저장된 의사결정 목록 -->
    <div id="decisions-list-section" class="decisions-list-section" style="display: none">
      <h3>저장된 의사결정 문서</h3>
      <div id="decisions-list"></div>
    </div>

    <script src="/static/js/components/utils.js"></script>
    <script src="/static/js/components/layout-component.js"></script>
    <script src="/static/js/components/header-component.js"></script>
    <script src="/static/js/components/ollama-model-options.js"></script>
    <!-- Phase 10-2: 모드별 시각화 -->
    <script src="/static/libs/mermaid/mermaid.min.js"></script>
    <script src="/static/libs/chartjs/chart.min.js"></script>
    <!-- Phase 10-3-3: PDF 내보내기 -->
    <script src="/static/libs/html2canvas/html2canvas.min.js"></script>
    <script src="/static/libs/jspdf/jspdf.umd.min.js"></script>
    <!-- Reason Lab 리팩터링: model → common → viz-loader → render → control → entry -->
    <script src="/static/js/reason/reason-model.js"></script>
    <script src="/static/js/reason/reason-common.js"></script>
    <script src="/static/js/reason/reason-viz-loader.js"></script>
    <script src="/static/js/reason/reason-render-viz.js"></script>
    <script src="/static/js/reason/reason-render.js"></script>
    <script src="/static/js/reason/reason-control.js"></script>
    <script src="/static/js/reason/reason-pdf-export.js"></script>
    <script src="/static/js/reason/reason.js"></script>
  </body>
</html>
