<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml" />
    <title>Personal AI Brain - Knowledge Admin</title>
    <style>
      /* Layout ìŠ¤íƒ€ì¼ì€ layout-component.jsì—ì„œ ê´€ë¦¬ */

      /* Header ìŠ¤íƒ€ì¼ì€ header-component.jsì—ì„œ ê´€ë¦¬ */

      .admin-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .admin-panel {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .admin-panel h3 {
        color: #2563eb;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e5e7eb;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #2563eb;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: all 0.2s;
      }

      .btn-primary {
        background: #2563eb;
        color: white;
      }

      .btn-primary:hover {
        background: #1d4ed8;
      }

      .btn-danger {
        background: #dc2626;
        color: white;
      }

      .btn-danger:hover {
        background: #b91c1c;
      }

      .btn-small {
        padding: 5px 10px;
        font-size: 12px;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      .table th,
      .table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
      }

      .table th {
        background: #f9fafb;
        font-weight: 600;
        color: #333;
      }

      .table tr:hover {
        background: #f9fafb;
      }

      .label-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        margin-right: 5px;
      }

      .label-badge.project_phase {
        background: #dbeafe;
        color: #1e40af;
      }

      .label-badge.role {
        background: #fce7f3;
        color: #9f1239;
      }

      .label-badge.domain {
        background: #dcfce7;
        color: #166534;
      }

      .label-badge.importance {
        background: #fef3c7;
        color: #92400e;
      }

      .chunk-selector {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid #e5e7eb;
      }

      .chunk-selector h4 {
        margin-bottom: 15px;
        color: #333;
      }

      .chunk-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 10px;
      }

      .chunk-item-select {
        padding: 10px;
        margin-bottom: 8px;
        background: #f9fafb;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .chunk-item-select:hover {
        background: #e5e7eb;
      }

      .chunk-item-select.selected {
        background: #dbeafe;
        border: 2px solid #2563eb;
      }

      .chunk-item-select .chunk-preview {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }

      .chunk-labels {
        margin-top: 15px;
      }

      .chunk-labels .current-labels {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 10px;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .error {
        background: #fee2e2;
        color: #991b1b;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
      }

      .success {
        background: #d1fae5;
        color: #065f46;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
      }

      /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
      .tab-navigation {
        background: white;
        padding: 0 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
      }

      .tab-nav-btn {
        padding: 12px 24px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-weight: 500;
        font-size: 16px;
        color: #666;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
      }

      .tab-nav-btn:hover {
        color: #2563eb;
      }

      .tab-nav-btn.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
      }

      .tab-content {
        display: block;
      }

      /* Phase 7.7: í‚¤ì›Œë“œ ê·¸ë£¹ ê´€ë¦¬ ìŠ¤íƒ€ì¼ */
      .group-card,
      .keyword-card {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .group-card:hover,
      .keyword-card:hover {
        border-color: #2563eb;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
      }

      .group-card.selected,
      .keyword-card.selected {
        border-color: #2563eb;
        background: #eff6ff;
      }

      .group-card {
        border-left: 4px solid #4f46e5; /* ê¸°ë³¸ ìƒ‰ìƒ */
      }

      /* ê·¸ë£¹ ìƒ‰ìƒì´ ìˆìœ¼ë©´ border-leftì— ì ìš© */
      .group-card[data-group-color] {
        border-left-color: var(--group-color);
      }

      .keyword-card {
        border-left: 4px solid #10b981;
      }

      .group-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .group-card-name {
        font-weight: 600;
        color: #1f2937;
      }

      .group-card-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 1px solid #e5e7eb;
      }

      .group-card-description {
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 8px;
      }

      .group-card-keywords-count {
        font-size: 12px;
        color: #9ca3af;
      }

      /* í‚¤ì›Œë“œ ë°°ì§€ ìŠ¤íƒ€ì¼ */
      .keyword-badge {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
        background: #f3f4f6;
        color: #6b7280;
      }

      .keyword-badge:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* í™œì„±í™” ìƒíƒœ */
      .keyword-badge.active {
        background: #2563eb;
        color: white;
        border-color: #2563eb;
      }

      /* ë¹„í™œì„±í™” ìƒíƒœ */
      .keyword-badge.inactive {
        background: #f3f4f6;
        color: #6b7280;
        border-color: #e5e7eb;
      }

      /* ì„ íƒëœ ìƒíƒœ (ë§¤ì¹­ ëª¨ë“œ) */
      .keyword-badge.selected {
        background: #eff6ff;
        color: #2563eb;
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
      }

      .keyword-card-name {
        font-weight: 500;
        color: #1f2937;
        margin-bottom: 5px;
      }

      .keyword-card-group {
        font-size: 12px;
        color: #6b7280;
      }

      .keyword-card-count {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 5px;
      }

      /* ìŠ¹ì¸ ì„¼í„° ìŠ¤íƒ€ì¼ */
      .status-filter-btn {
        padding: 8px 16px;
        border: 2px solid #e5e7eb;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: all 0.2s;
      }

      .status-filter-btn:hover {
        border-color: #2563eb;
        color: #2563eb;
      }

      .status-filter-btn.active {
        background: #2563eb;
        color: white;
        border-color: #2563eb;
      }

      .approval-chunk-list {
        display: grid;
        gap: 15px;
      }

      .approval-chunk-card {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .approval-chunk-card:hover {
        border-color: #2563eb;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
      }

      .approval-chunk-card.draft {
        border-left: 4px solid #f59e0b;
      }

      .approval-chunk-card.approved {
        border-left: 4px solid #10b981;
      }

      .approval-chunk-card.rejected {
        border-left: 4px solid #ef4444;
      }

      .chunk-card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 10px;
      }

      .chunk-card-status {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      .chunk-card-status.draft {
        background: #fef3c7;
        color: #92400e;
      }

      .chunk-card-status.approved {
        background: #d1fae5;
        color: #065f46;
      }

      .chunk-card-status.rejected {
        background: #fee2e2;
        color: #991b1b;
      }

      .chunk-card-content {
        color: #333;
        line-height: 1.6;
        margin-bottom: 15px;
        max-height: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .chunk-card-meta {
        font-size: 12px;
        color: #666;
        margin-bottom: 10px;
      }

      .chunk-card-actions {
        display: flex;
        gap: 10px;
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-success:hover {
        background: #059669;
      }

      /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: white;
        border-radius: 8px;
        max-width: 900px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 2px solid #e5e7eb;
      }

      .modal-header h3 {
        margin: 0;
        color: #2563eb;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #666;
        padding: 0;
        width: 30px;
        height: 30px;
        line-height: 30px;
      }

      .modal-close:hover {
        color: #2563eb;
      }

      .modal-body {
        padding: 20px;
      }

      .chunk-detail-section {
        margin-bottom: 25px;
      }

      .chunk-detail-section h4 {
        color: #2563eb;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e5e7eb;
      }

      .suggestion-block {
        background: #f9fafb;
        border-left: 3px solid #2563eb;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
      }

      .suggestion-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: white;
        border-radius: 4px;
        margin-bottom: 8px;
      }

      .suggestion-item:last-child {
        margin-bottom: 0;
      }

      .suggestion-info {
        flex: 1;
      }

      .suggestion-confidence {
        font-size: 12px;
        color: #666;
        margin-left: 10px;
      }

      .similar-chunk-item {
        padding: 12px;
        background: white;
        border-radius: 6px;
        margin-bottom: 10px;
        border-left: 3px solid #10b981;
        cursor: pointer;
      }

      .similar-chunk-item:hover {
        background: #f0fdf4;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- HeaderëŠ” JavaScriptë¡œ ë™ì  ìƒì„± -->
      <div id="header-placeholder"></div>

      <div id="error-message" class="error" style="display: none"></div>
      <div id="success-message" class="success" style="display: none"></div>

      <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
      <div class="tab-navigation" style="margin-bottom: 20px; border-bottom: 2px solid #e5e7eb">
        <button class="tab-nav-btn active" onclick="switchTab('labels')" id="tab-labels">ğŸ·ï¸ ë¼ë²¨ ê´€ë¦¬</button>
        <button class="tab-nav-btn" onclick="switchTab('groups')" id="tab-groups">ğŸ“¦ í‚¤ì›Œë“œ ê·¸ë£¹</button>
        <button class="tab-nav-btn" onclick="switchTab('approval')" id="tab-approval">âœ… ì²­í¬ ìŠ¹ì¸ ì„¼í„°</button>
      </div>

      <!-- ë¼ë²¨ ê´€ë¦¬ íƒ­ -->
      <div id="tab-content-labels" class="tab-content">
        <div class="admin-container">
          <!-- ë¼ë²¨ ê´€ë¦¬ íŒ¨ë„ -->
          <div class="admin-panel">
            <h3>ğŸ·ï¸ ë¼ë²¨ ê´€ë¦¬</h3>

            <!-- ë¼ë²¨ ìƒì„± í¼ -->
            <form id="label-form" onsubmit="createLabel(event)">
              <div class="form-group">
                <label>ë¼ë²¨ ì´ë¦„</label>
                <input type="text" id="label-name" required placeholder="ì˜ˆ: ai, architecture" />
              </div>
              <div class="form-group">
                <label>ë¼ë²¨ íƒ€ì…</label>
                <select id="label-type" required>
                  <option value="project_phase">í”„ë¡œì íŠ¸ ë‹¨ê³„ (project_phase)</option>
                  <option value="role">ì—­í•  (role)</option>
                  <option value="domain">ë„ë©”ì¸ (domain)</option>
                  <option value="importance">ì¤‘ìš”ë„ (importance)</option>
                  <option value="keyword">í‚¤ì›Œë“œ (keyword)</option>
                </select>
              </div>
              <div class="form-group">
                <label>ì„¤ëª… (ì„ íƒì‚¬í•­)</label>
                <input type="text" id="label-description" placeholder="ë¼ë²¨ì— ëŒ€í•œ ì„¤ëª…" />
              </div>
              <button type="submit" class="btn btn-primary">ë¼ë²¨ ìƒì„±</button>
            </form>

            <!-- ë¼ë²¨ ëª©ë¡ -->
            <div style="margin-top: 30px">
              <h4>í˜„ì¬ ë¼ë²¨ ëª©ë¡</h4>
              <table class="table">
                <thead>
                  <tr>
                    <th>ì´ë¦„</th>
                    <th>íƒ€ì…</th>
                    <th>ì„¤ëª…</th>
                    <th>ì‘ì—…</th>
                  </tr>
                </thead>
                <tbody id="labels-table">
                  <tr>
                    <td colspan="4" class="loading">ë¼ë²¨ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- ì²­í¬ ë¼ë²¨ ê´€ë¦¬ íŒ¨ë„ -->
          <div class="admin-panel">
            <h3>ğŸ“ ì²­í¬ ë¼ë²¨ ê´€ë¦¬</h3>

            <div class="chunk-selector">
              <h4>ì²­í¬ ì„ íƒ</h4>
              <div class="form-group">
                <input type="text" id="chunk-search" placeholder="ì²­í¬ ê²€ìƒ‰..." onkeyup="searchChunks()" />
              </div>
              <div class="chunk-list" id="chunk-list">
                <div class="loading">ì²­í¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
              </div>
            </div>

            <div class="chunk-labels" id="chunk-labels-section" style="display: none">
              <h4>ì„ íƒëœ ì²­í¬ì˜ ë¼ë²¨</h4>
              <div id="current-chunk-info" style="margin-bottom: 15px; padding: 10px; background: #f9fafb; border-radius: 4px; font-size: 12px; color: #666"></div>
              <div class="current-labels" id="current-labels">
                <!-- í˜„ì¬ ë¼ë²¨ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë¨ -->
              </div>
              <div class="form-group">
                <label>ë¼ë²¨ ì¶”ê°€</label>
                <select id="add-label-select">
                  <option value="">ë¼ë²¨ ì„ íƒ...</option>
                </select>
              </div>
              <button type="button" class="btn btn-primary" onclick="addLabelToChunk()">ë¼ë²¨ ì¶”ê°€</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Phase 7.7: í‚¤ì›Œë“œ ê·¸ë£¹ ê´€ë¦¬ íƒ­ -->
      <div id="tab-content-groups" class="tab-content" style="display: none">
        <div class="admin-panel">
          <h3>ğŸ“¦ í‚¤ì›Œë“œ ê·¸ë£¹ ê´€ë¦¬</h3>

          <!-- ìƒë‹¨ ë°”: ê²€ìƒ‰ -->
          <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center">
            <input
              type="text"
              id="group-search-input"
              placeholder="ê·¸ë£¹/í‚¤ì›Œë“œ ê²€ìƒ‰..."
              style="flex: 1; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px"
              onkeyup="searchGroupsAndKeywords()"
            />
          </div>

          <!-- ì¢Œìš° ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒ -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px">
            <!-- ì¢Œì¸¡: í‚¤ì›Œë“œ ê·¸ë£¹ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
            <div>
              <h4 style="margin-bottom: 15px; color: #2563eb">í‚¤ì›Œë“œ ê·¸ë£¹</h4>
              <div style="display: flex; gap: 10px; margin-bottom: 15px">
                <button class="btn btn-primary btn-small" onclick="showCreateGroupModal()">+ ìƒˆ ê·¸ë£¹</button>
              </div>
              <div id="groups-list" style="display: flex; flex-direction: column; gap: 10px; max-height: 500px; overflow-y: auto">
                <div class="loading">ê·¸ë£¹ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
              </div>
            </div>

            <!-- ìš°ì¸¡: í‚¤ì›Œë“œ ëª©ë¡ -->
            <div>
              <h4 style="margin-bottom: 15px; color: #2563eb">í‚¤ì›Œë“œ ëª©ë¡</h4>
              <div id="keywords-list" style="display: flex; flex-wrap: wrap; gap: 8px; max-height: 500px; overflow-y: auto; padding: 10px">
                <div class="loading">í‚¤ì›Œë“œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
              </div>
            </div>
          </div>

          <!-- í•˜ë‹¨ ê³ ì • ë°”: ì„ íƒ ìš”ì•½ + ì¼ê´„ ì ìš© ë²„íŠ¼ -->
          <div
            id="matching-summary-bar"
            style="display: none; position: sticky; bottom: 0; background: white; padding: 15px; border-top: 2px solid #e5e7eb; border-radius: 8px; margin-top: 20px"
          >
            <div style="display: flex; justify-content: space-between; align-items: center">
              <div id="selection-summary" style="font-weight: 500; color: #333"></div>
              <div style="display: flex; gap: 10px">
                <button class="btn btn-primary" onclick="applyGroupKeywords()">ì´ ê·¸ë£¹ì— ì—°ê²°</button>
                <button class="btn" style="background: #e5e7eb; color: #333" onclick="clearSelection()">ì„ íƒ ì·¨ì†Œ</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ì²­í¬ ìŠ¹ì¸ ì„¼í„° íƒ­ -->
      <div id="tab-content-approval" class="tab-content" style="display: none">
        <div class="admin-panel">
          <h3>âœ… ì²­í¬ ìŠ¹ì¸ ì„¼í„°</h3>

          <!-- ìƒíƒœ í•„í„° -->
          <div style="margin-bottom: 20px">
            <div style="display: flex; gap: 10px; margin-bottom: 15px">
              <button class="status-filter-btn active" onclick="filterByStatus('draft')" data-status="draft">ğŸ“ ëŒ€ê¸° ì¤‘ (Draft)</button>
              <button class="status-filter-btn" onclick="filterByStatus('approved')" data-status="approved">âœ… ìŠ¹ì¸ë¨ (Approved)</button>
              <button class="status-filter-btn" onclick="filterByStatus('rejected')" data-status="rejected">âŒ ê±°ì ˆë¨ (Rejected)</button>
            </div>
          </div>

          <!-- ì²­í¬ ëª©ë¡ -->
          <div id="approval-chunk-list" class="approval-chunk-list">
            <div class="loading">ì²­í¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>

          <!-- ì²­í¬ ìƒì„¸ ëª¨ë‹¬ -->
          <div id="chunk-detail-modal" class="modal" style="display: none">
            <div class="modal-content">
              <div class="modal-header">
                <h3>ì²­í¬ ìƒì„¸</h3>
                <button class="modal-close" onclick="closeChunkDetail()">Ã—</button>
              </div>
              <div id="chunk-detail-body" class="modal-body">
                <!-- ì²­í¬ ìƒì„¸ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë¨ -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ê·¸ë£¹ ìƒì„± ëª¨ë‹¬ -->
      <div id="create-group-modal" class="modal" style="display: none">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="group-modal-title">ìƒˆ í‚¤ì›Œë“œ ê·¸ë£¹ ìƒì„±</h3>
            <button class="modal-close" onclick="closeCreateGroupModal()">Ã—</button>
          </div>
          <div class="modal-body">
            <form id="create-group-form" onsubmit="handleCreateGroup(event)">
              <div class="form-group">
                <label>ê·¸ë£¹ ì´ë¦„ *</label>
                <input type="text" id="group-name-input" required placeholder="ì˜ˆ: AI ì¸í”„ë¼" />
              </div>
              <div class="form-group">
                <label>ì„¤ëª…</label>
                <textarea id="group-description-input" rows="3" placeholder="ê·¸ë£¹ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                <!-- ì—ëŸ¬/ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ (ì‹œë‚˜ë¦¬ì˜¤ 2 ê°œì„ ) -->
                <div
                  id="keyword-suggestion-error"
                  class="error"
                  style="
                    display: none;
                    margin-top: 8px;
                    margin-bottom: 8px;
                    padding: 10px;
                    font-size: 12px;
                    background: #fee2e2;
                    color: #991b1b;
                    border-radius: 6px;
                    border: 1px solid #fecaca;
                  "
                ></div>
                <div
                  id="keyword-suggestion-success"
                  class="success"
                  style="
                    display: none;
                    margin-top: 8px;
                    margin-bottom: 8px;
                    padding: 10px;
                    font-size: 12px;
                    background: #d1fae5;
                    color: #065f46;
                    border-radius: 6px;
                    border: 1px solid #a7f3d0;
                  "
                ></div>
                <button
                  type="button"
                  class="btn btn-small"
                  style="margin-top: 8px; background: #f3f4f6; color: #333"
                  onclick="suggestKeywordsFromDescription()"
                  id="suggest-keywords-btn"
                >
                  ğŸ’¡ ì„¤ëª… ê¸°ë°˜ í‚¤ì›Œë“œ ì¶”ì²œ
                </button>
                <div id="suggested-keywords-container" style="display: none; margin-top: 10px; padding: 10px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px">
                    <div style="font-size: 12px; color: #666; font-weight: 500">ì¶”ì²œ í‚¤ì›Œë“œ:</div>
                    <button type="button" class="btn btn-small" style="padding: 4px 8px; font-size: 11px; background: #fee2e2; color: #991b1b" onclick="clearSuggestedKeywords()">
                      ì „ì²´ì‚­ì œ
                    </button>
                  </div>
                  <div id="suggested-keywords-list" style="display: flex; flex-wrap: wrap; gap: 6px"></div>
                </div>
              </div>
              <div class="form-group">
                <label>ìƒ‰ìƒ ì½”ë“œ</label>
                <input type="text" id="group-color-input" placeholder="#4F46E5" pattern="^#[0-9A-Fa-f]{6}$" />
                <small style="color: #666; font-size: 12px; display: block; margin-top: 5px">16ì§„ìˆ˜ ìƒ‰ìƒ ì½”ë“œ (ì˜ˆ: #4F46E5)</small>
              </div>
              <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px">
                <button type="button" class="btn" style="background: #e5e7eb; color: #333" onclick="closeCreateGroupModal()">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-primary" id="group-submit-btn">ìƒì„±</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="/static/js/layout-component.js"></script>
    <script src="/static/js/header-component.js"></script>
    <script>
      let allLabels = [];
      let allChunks = [];
      let selectedChunkId = null;
      let currentStatusFilter = "draft";
      let pendingChunks = [];

      // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í™•ì¸ í›„ ì´ˆê¸°í™”
      function initializePage() {
        // Layout ì´ˆê¸°í™”
        if (typeof initLayout === "function") {
          initLayout();
        } else {
          console.error("initLayout í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. layout-component.jsê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
        }

        // Header ë Œë”ë§ - ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í™•ì¸
        const headerPlaceholder = document.getElementById("header-placeholder");
        const container = document.querySelector(".container");

        // renderHeader í•¨ìˆ˜ê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
        function tryRenderHeader(attempts = 0) {
          if (typeof renderHeader === "function" || typeof window.renderHeader === "function") {
            const renderFn = renderHeader || window.renderHeader;

            // header-placeholder ì œê±°
            if (headerPlaceholder) {
              headerPlaceholder.remove();
            }

            // Header ë Œë”ë§
            renderFn({
              title: "âš™ï¸ Knowledge Admin",
              subtitle: "ì§€ì‹ êµ¬ì¡° ê´€ë¦¬",
              currentPath: "/knowledge-admin",
              containerSelector: ".container",
              insertPosition: "afterbegin",
            });
          } else if (attempts < 10) {
            // ìµœëŒ€ 10ë²ˆê¹Œì§€ ì¬ì‹œë„ (1ì´ˆ)
            setTimeout(() => tryRenderHeader(attempts + 1), 100);
          } else {
            console.error("renderHeader í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. header-component.jsê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
            // í´ë°±: ê°„ë‹¨í•œ header í‘œì‹œ
            if (headerPlaceholder) {
              headerPlaceholder.innerHTML = `
                <header>
                  <h1>âš™ï¸ Knowledge Admin</h1>
                  <p>ì§€ì‹ êµ¬ì¡° ê´€ë¦¬</p>
                  <nav>
                    <a href="/dashboard">ëŒ€ì‹œë³´ë“œ</a>
                    <a href="/knowledge">Knowledge Studio</a>
                    <a href="/reason">Reasoning Lab</a>
                    <a href="/knowledge-admin">ì§€ì‹ ê´€ë¦¬</a>
                  </nav>
                </header>
              `;
            }
          }
        }

        tryRenderHeader();

        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        loadLabels();
        loadChunks();
        loadPendingChunks();
      }

      // DOMContentLoaded ë˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", function () {
          // ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
          setTimeout(initializePage, 200);
        });
      } else {
        // ì´ë¯¸ ë¡œë“œëœ ê²½ìš°
        setTimeout(initializePage, 200);
      }

      // íƒ­ ì „í™˜
      function switchTab(tab) {
        // íƒ­ ë²„íŠ¼ í™œì„±í™”
        document.querySelectorAll(".tab-nav-btn").forEach((btn) => btn.classList.remove("active"));
        document.getElementById(`tab-${tab}`).classList.add("active");

        // íƒ­ ì»¨í…ì¸  í‘œì‹œ/ìˆ¨ê¹€
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.style.display = "none";
        });
        const tabContent = document.getElementById(`tab-content-${tab}`);
        if (tabContent) {
          tabContent.style.display = "block";
        }

        // í‚¤ì›Œë“œ ê·¸ë£¹ íƒ­ìœ¼ë¡œ ì „í™˜ ì‹œ ë°ì´í„° ë¡œë“œ
        if (tab === "groups") {
          loadGroups();
          loadKeywords();
        }

        // íƒ­ ì½˜í…ì¸  í‘œì‹œ
        document.querySelectorAll(".tab-content").forEach((content) => (content.style.display = "none"));
        document.getElementById(`tab-content-${tab}`).style.display = "block";
      }

      // ìƒíƒœ í•„í„°
      function filterByStatus(status) {
        currentStatusFilter = status;

        // í•„í„° ë²„íŠ¼ í™œì„±í™”
        document.querySelectorAll(".status-filter-btn").forEach((btn) => {
          btn.classList.remove("active");
          if (btn.dataset.status === status) {
            btn.classList.add("active");
          }
        });

        loadPendingChunks();
      }

      // ìŠ¹ì¸ ëŒ€ê¸° ì²­í¬ ë¡œë“œ
      async function loadPendingChunks() {
        const chunkList = document.getElementById("approval-chunk-list");
        chunkList.innerHTML = '<div class="loading">ì²­í¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

        try {
          const response = await fetch(`/api/approval/chunks/pending?status=${currentStatusFilter}&limit=50`);
          if (!response.ok) {
            throw new Error("ì²­í¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }

          pendingChunks = await response.json();
          displayPendingChunks();
        } catch (error) {
          console.error("ìŠ¹ì¸ ëŒ€ê¸° ì²­í¬ ë¡œë“œ ì‹¤íŒ¨:", error);
          chunkList.innerHTML = '<div class="error">ì²­í¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
      }

      // ìŠ¹ì¸ ëŒ€ê¸° ì²­í¬ í‘œì‹œ
      function displayPendingChunks() {
        const chunkList = document.getElementById("approval-chunk-list");

        if (pendingChunks.length === 0) {
          chunkList.innerHTML = '<div class="loading">í•´ë‹¹ ìƒíƒœì˜ ì²­í¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        chunkList.innerHTML = pendingChunks
          .map((chunk) => {
            const statusClass = chunk.status || "draft";
            const statusText =
              {
                draft: "ğŸ“ ëŒ€ê¸° ì¤‘",
                approved: "âœ… ìŠ¹ì¸ë¨",
                rejected: "âŒ ê±°ì ˆë¨",
              }[statusClass] || "ğŸ“ ëŒ€ê¸° ì¤‘";

            return `
            <div class="approval-chunk-card ${statusClass}" onclick="showChunkDetail(${chunk.id})">
              <div class="chunk-card-header">
                <div>
                  <div class="chunk-card-meta">
                    ì²­í¬ ID: ${chunk.id} | ë¬¸ì„œ ID: ${chunk.document_id} | ì¸ë±ìŠ¤: ${chunk.chunk_index}
                  </div>
                  <div class="chunk-card-content">${chunk.content}</div>
                </div>
                <span class="chunk-card-status ${statusClass}">${statusText}</span>
              </div>
              <div class="chunk-card-actions">
                ${
                  statusClass === "draft"
                    ? `
                  <button class="btn btn-success btn-small" onclick="event.stopPropagation(); approveChunk(${chunk.id})">âœ… ìŠ¹ì¸</button>
                  <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); rejectChunk(${chunk.id})">âŒ ê±°ì ˆ</button>
                `
                    : ""
                }
                <button class="btn btn-primary btn-small" onclick="event.stopPropagation(); showChunkDetail(${chunk.id})">ìƒì„¸ ë³´ê¸°</button>
              </div>
            </div>
          `;
          })
          .join("");
      }

      // ì²­í¬ ìŠ¹ì¸
      async function approveChunk(chunkId) {
        if (!confirm("ì´ ì²­í¬ë¥¼ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          return;
        }

        try {
          const response = await fetch(`/api/approval/chunks/${chunkId}/approve`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              approved_by: "admin",
            }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || "ì²­í¬ ìŠ¹ì¸ ì‹¤íŒ¨");
          }

          showSuccess("ì²­í¬ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
          loadPendingChunks();
        } catch (error) {
          console.error("ì²­í¬ ìŠ¹ì¸ ì‹¤íŒ¨:", error);
          showError(error.message || "ì²­í¬ ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì²­í¬ ê±°ì ˆ
      async function rejectChunk(chunkId) {
        const reason = prompt("ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­):");

        if (reason === null) {
          return; // ì·¨ì†Œ
        }

        try {
          const response = await fetch(`/api/approval/chunks/${chunkId}/reject`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              reason: reason || null,
            }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || "ì²­í¬ ê±°ì ˆ ì‹¤íŒ¨");
          }

          showSuccess("ì²­í¬ê°€ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.");
          loadPendingChunks();
        } catch (error) {
          console.error("ì²­í¬ ê±°ì ˆ ì‹¤íŒ¨:", error);
          showError(error.message || "ì²­í¬ ê±°ì ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì²­í¬ ìƒì„¸ ë³´ê¸°
      async function showChunkDetail(chunkId) {
        const modal = document.getElementById("chunk-detail-modal");
        const body = document.getElementById("chunk-detail-body");

        body.innerHTML = '<div class="loading">ì²­í¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        modal.style.display = "flex";

        try {
          // ì²­í¬ ìƒì„¸ ì •ë³´ ë¡œë“œ
          const chunkResponse = await fetch(`/api/knowledge/chunks/${chunkId}`);
          if (!chunkResponse.ok) {
            throw new Error("ì²­í¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }
          const chunk = await chunkResponse.json();

          // AI ë¼ë²¨ ì¶”ì²œ ë¡œë“œ
          let labelSuggestions = [];
          try {
            const labelResponse = await fetch(`/api/knowledge/labels/suggest?chunk_id=${chunkId}`);
            if (labelResponse.ok) {
              const labelData = await labelResponse.json();
              labelSuggestions = labelData.suggestions || [];
            }
          } catch (e) {
            console.error("ë¼ë²¨ ì¶”ì²œ ë¡œë“œ ì‹¤íŒ¨:", e);
          }

          // AI ê´€ê³„ ì¶”ì²œ ë¡œë“œ
          let relationSuggestions = [];
          try {
            const relationResponse = await fetch(`/api/knowledge/relations/suggest?chunk_id=${chunkId}&limit=5`);
            if (relationResponse.ok) {
              const relationData = await relationResponse.json();
              relationSuggestions = relationData.suggestions || [];
            }
          } catch (e) {
            console.error("ê´€ê³„ ì¶”ì²œ ë¡œë“œ ì‹¤íŒ¨:", e);
          }

          // ìƒì„¸ ì •ë³´ í‘œì‹œ
          body.innerHTML = `
            <div class="chunk-detail-section">
              <h4>ì²­í¬ ë‚´ìš©</h4>
              <div style="background: #f9fafb; padding: 15px; border-radius: 6px; white-space: pre-wrap;">${chunk.content || "ë‚´ìš© ì—†ìŒ"}</div>
            </div>
            
            <div class="chunk-detail-section">
              <h4>í˜„ì¬ ë¼ë²¨</h4>
              <div class="current-labels">
                ${
                  chunk.labels && chunk.labels.length > 0
                    ? chunk.labels
                        .map(
                          (label) => `
                      <span class="label-badge ${label.label_type || "default"}">${label.name}</span>
                    `
                        )
                        .join("")
                    : '<p style="color: #999;">ë¼ë²¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>'
                }
              </div>
            </div>
            
            ${
              labelSuggestions.length > 0
                ? `
            <div class="chunk-detail-section">
              <h4>ğŸ¤– AI ë¼ë²¨ ì¶”ì²œ</h4>
              <div class="suggestion-block">
                ${labelSuggestions
                  .map(
                    (suggestion) => `
                  <div class="suggestion-item">
                    <div class="suggestion-info">
                      <span class="label-badge ${suggestion.label_type || "default"}">${suggestion.label_name}</span>
                      <span class="suggestion-confidence">ì‹ ë¢°ë„: ${(suggestion.confidence * 100).toFixed(0)}%</span>
                    </div>
                    <button class="btn btn-primary btn-small" onclick="applyLabelSuggestion(${chunkId}, ${suggestion.label_id}, ${suggestion.confidence})">ì ìš©</button>
                  </div>
                `
                  )
                  .join("")}
              </div>
            </div>
            `
                : ""
            }
            
            ${
              relationSuggestions.length > 0
                ? `
            <div class="chunk-detail-section">
              <h4>ğŸ”— AI ìœ ì‚¬ ì²­í¬ ì¶”ì²œ</h4>
              <div class="suggestion-block">
                ${relationSuggestions
                  .map(
                    (suggestion) => `
                  <div class="similar-chunk-item" onclick="showChunkDetail(${suggestion.target_chunk_id})">
                    <div style="font-weight: 600; margin-bottom: 5px;">ì²­í¬ ID: ${suggestion.target_chunk_id}</div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">${suggestion.target_content_preview}</div>
                    <div style="font-size: 11px; color: #999;">ìœ ì‚¬ë„: ${(suggestion.score * 100).toFixed(0)}%</div>
                  </div>
                `
                  )
                  .join("")}
              </div>
            </div>
            `
                : ""
            }
            
            <div class="chunk-detail-section">
              <h4>ì‘ì—…</h4>
              <div style="display: flex; gap: 10px;">
                ${
                  chunk.status === "draft"
                    ? `
                  <button class="btn btn-success" onclick="approveChunk(${chunkId}); closeChunkDetail();">âœ… ìŠ¹ì¸</button>
                  <button class="btn btn-danger" onclick="rejectChunk(${chunkId}); closeChunkDetail();">âŒ ê±°ì ˆ</button>
                `
                    : ""
                }
                <button class="btn btn-secondary" onclick="closeChunkDetail()">ë‹«ê¸°</button>
              </div>
            </div>
          `;
        } catch (error) {
          console.error("ì²­í¬ ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨:", error);
          body.innerHTML = '<div class="error">ì²­í¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
      }

      // ì²­í¬ ìƒì„¸ ë‹«ê¸°
      function closeChunkDetail() {
        document.getElementById("chunk-detail-modal").style.display = "none";
      }

      // ë¼ë²¨ ì¶”ì²œ ì ìš©
      async function applyLabelSuggestion(chunkId, labelId, confidence) {
        try {
          const response = await fetch(`/api/knowledge/labels/suggest/${chunkId}/apply/${labelId}?confidence=${confidence}`, {
            method: "POST",
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || "ë¼ë²¨ ì ìš© ì‹¤íŒ¨");
          }

          showSuccess("ë¼ë²¨ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
          showChunkDetail(chunkId); // ìƒì„¸ ì •ë³´ ìƒˆë¡œê³ ì¹¨
        } catch (error) {
          console.error("ë¼ë²¨ ì ìš© ì‹¤íŒ¨:", error);
          showError(error.message || "ë¼ë²¨ ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ë¼ë²¨ ëª©ë¡ ë¡œë“œ
      async function loadLabels() {
        try {
          const response = await fetch("/api/labels");
          allLabels = await response.json();
          displayLabels();
          updateLabelSelect();
        } catch (error) {
          console.error("ë¼ë²¨ ë¡œë“œ ì‹¤íŒ¨:", error);
          showError("ë¼ë²¨ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
      }

      // ë¼ë²¨ í‘œì‹œ
      function displayLabels() {
        const tbody = document.getElementById("labels-table");
        if (allLabels.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">ë“±ë¡ëœ ë¼ë²¨ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          return;
        }

        tbody.innerHTML = allLabels
          .map((label) => {
            const typeClass = label.label_type || "default";
            return `
            <tr>
              <td><span class="label-badge ${typeClass}">${label.name}</span></td>
              <td>${label.label_type || "N/A"}</td>
              <td>${label.description || "-"}</td>
              <td>
                <button class="btn btn-danger btn-small" onclick="deleteLabel(${label.id})">ì‚­ì œ</button>
              </td>
            </tr>
          `;
          })
          .join("");
      }

      // ë¼ë²¨ ìƒì„±
      async function createLabel(event) {
        event.preventDefault();

        const name = document.getElementById("label-name").value.trim();
        const labelType = document.getElementById("label-type").value;
        const description = document.getElementById("label-description").value.trim();

        try {
          const response = await fetch("/api/labels", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              name: name,
              label_type: labelType,
              description: description || null,
            }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || "ë¼ë²¨ ìƒì„± ì‹¤íŒ¨");
          }

          showSuccess("ë¼ë²¨ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
          document.getElementById("label-form").reset();
          loadLabels();
        } catch (error) {
          console.error("ë¼ë²¨ ìƒì„± ì‹¤íŒ¨:", error);
          showError(error.message || "ë¼ë²¨ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ë¼ë²¨ ì‚­ì œ
      async function deleteLabel(labelId) {
        if (!confirm("ì´ ë¼ë²¨ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          return;
        }

        try {
          const response = await fetch(`/api/labels/${labelId}`, {
            method: "DELETE",
          });

          if (!response.ok) {
            throw new Error("ë¼ë²¨ ì‚­ì œ ì‹¤íŒ¨");
          }

          showSuccess("ë¼ë²¨ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          loadLabels();
        } catch (error) {
          console.error("ë¼ë²¨ ì‚­ì œ ì‹¤íŒ¨:", error);
          showError("ë¼ë²¨ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì²­í¬ ëª©ë¡ ë¡œë“œ
      async function loadChunks() {
        try {
          const response = await fetch("/api/knowledge/chunks?limit=100");
          const data = await response.json();
          // APIëŠ” ë°°ì—´ì„ ì§ì ‘ ë°˜í™˜í•˜ë¯€ë¡œ ë°°ì—´ì¸ì§€ í™•ì¸
          allChunks = Array.isArray(data) ? data : data.chunks || [];
          displayChunks();
        } catch (error) {
          console.error("ì²­í¬ ë¡œë“œ ì‹¤íŒ¨:", error);
          showError("ì²­í¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
      }

      // ì²­í¬ í‘œì‹œ
      function displayChunks(filteredChunks = null) {
        const chunks = filteredChunks || allChunks;
        const chunkList = document.getElementById("chunk-list");

        if (chunks.length === 0) {
          chunkList.innerHTML = '<div class="loading">ì²­í¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        chunkList.innerHTML = chunks
          .map((chunk) => {
            const isSelected = selectedChunkId === chunk.id;
            return `
            <div class="chunk-item-select ${isSelected ? "selected" : ""}" onclick="selectChunk(${chunk.id})">
              <div><strong>ID: ${chunk.id}</strong></div>
              <div class="chunk-preview">${(chunk.content || "").substring(0, 100)}...</div>
            </div>
          `;
          })
          .join("");
      }

      // ì²­í¬ ê²€ìƒ‰
      function searchChunks() {
        const searchTerm = document.getElementById("chunk-search").value.toLowerCase();
        if (!searchTerm) {
          displayChunks();
          return;
        }

        const filtered = allChunks.filter((chunk) => {
          const content = (chunk.content || "").toLowerCase();
          return content.includes(searchTerm);
        });
        displayChunks(filtered);
      }

      // ì²­í¬ ì„ íƒ
      async function selectChunk(chunkId) {
        selectedChunkId = chunkId;
        displayChunks();

        // ì„ íƒëœ ì²­í¬ ì •ë³´ í‘œì‹œ
        const chunk = allChunks.find((c) => c.id === chunkId);
        if (chunk) {
          document.getElementById("current-chunk-info").textContent = `ì²­í¬ ID: ${chunk.id} | ${(chunk.content || "").substring(0, 150)}...`;
        }

        // ì²­í¬ì˜ í˜„ì¬ ë¼ë²¨ ë¡œë“œ
        await loadChunkLabels(chunkId);

        // ë¼ë²¨ ê´€ë¦¬ ì„¹ì…˜ í‘œì‹œ
        document.getElementById("chunk-labels-section").style.display = "block";
      }

      // ì²­í¬ì˜ ë¼ë²¨ ë¡œë“œ
      async function loadChunkLabels(chunkId) {
        try {
          const response = await fetch(`/api/labels/chunks/${chunkId}/labels`);
          const chunkLabels = await response.json();

          const currentLabelsDiv = document.getElementById("current-labels");
          if (chunkLabels.length === 0) {
            currentLabelsDiv.innerHTML = '<p style="color: #999; font-size: 12px;">ë¼ë²¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          } else {
            currentLabelsDiv.innerHTML = chunkLabels
              .map((label) => {
                const typeClass = label.label_type || "default";
                return `
                <span class="label-badge ${typeClass}">
                  ${label.name}
                  <button onclick="removeLabelFromChunk(${label.id})" style="margin-left: 5px; background: none; border: none; color: inherit; cursor: pointer; font-weight: bold;">Ã—</button>
                </span>
              `;
              })
              .join("");
          }
        } catch (error) {
          console.error("ì²­í¬ ë¼ë²¨ ë¡œë“œ ì‹¤íŒ¨:", error);
        }
      }

      // ë¼ë²¨ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
      function updateLabelSelect() {
        const select = document.getElementById("add-label-select");
        select.innerHTML = '<option value="">ë¼ë²¨ ì„ íƒ...</option>' + allLabels.map((label) => `<option value="${label.id}">${label.name} (${label.label_type})</option>`).join("");
      }

      // ì²­í¬ì— ë¼ë²¨ ì¶”ê°€
      async function addLabelToChunk() {
        if (!selectedChunkId) {
          showError("ë¨¼ì € ì²­í¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
          return;
        }

        const labelId = parseInt(document.getElementById("add-label-select").value);
        if (!labelId) {
          showError("ë¼ë²¨ì„ ì„ íƒí•˜ì„¸ìš”.");
          return;
        }

        try {
          const response = await fetch(`/api/labels/chunks/${selectedChunkId}/labels/${labelId}`, {
            method: "POST",
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || "ë¼ë²¨ ì¶”ê°€ ì‹¤íŒ¨");
          }

          showSuccess("ë¼ë²¨ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
          loadChunkLabels(selectedChunkId);
          document.getElementById("add-label-select").value = "";
        } catch (error) {
          console.error("ë¼ë²¨ ì¶”ê°€ ì‹¤íŒ¨:", error);
          showError(error.message || "ë¼ë²¨ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì²­í¬ì—ì„œ ë¼ë²¨ ì œê±°
      async function removeLabelFromChunk(labelId) {
        if (!selectedChunkId) {
          return;
        }

        if (!confirm("ì´ ë¼ë²¨ì„ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          return;
        }

        try {
          const response = await fetch(`/api/labels/chunks/${selectedChunkId}/labels/${labelId}`, {
            method: "DELETE",
          });

          if (!response.ok) {
            throw new Error("ë¼ë²¨ ì œê±° ì‹¤íŒ¨");
          }

          showSuccess("ë¼ë²¨ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.");
          loadChunkLabels(selectedChunkId);
        } catch (error) {
          console.error("ë¼ë²¨ ì œê±° ì‹¤íŒ¨:", error);
          showError("ë¼ë²¨ ì œê±° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
      function showError(message) {
        const errorDiv = document.getElementById("error-message");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
        setTimeout(() => {
          errorDiv.style.display = "none";
        }, 5000);
      }

      function showSuccess(message) {
        const successDiv = document.getElementById("success-message");
        successDiv.textContent = message;
        successDiv.style.display = "block";
        setTimeout(() => {
          successDiv.style.display = "none";
        }, 3000);
      }

      // ========== Phase 7.7: í‚¤ì›Œë“œ ê·¸ë£¹ ê´€ë¦¬ í•¨ìˆ˜ ==========

      let matchingMode = true; // ë§¤ì¹­ ëª¨ë“œ ìƒì‹œ í™œì„±í™”
      let selectedGroupId = null;
      let selectedKeywordIds = new Set();

      async function loadGroups() {
        try {
          const response = await fetch("/api/labels/groups");
          const groups = await response.json();

          const groupsList = document.getElementById("groups-list");
          if (!groupsList) return;
          groupsList.innerHTML = "";

          groups.forEach((group) => {
            const card = document.createElement("div");
            card.className = "group-card";
            card.dataset.groupId = group.id;
            // ê·¸ë£¹ ìƒ‰ìƒì„ border-leftì— ì ìš© (ì‹œë‚˜ë¦¬ì˜¤ 1 ê°œì„ )
            if (group.color) {
              card.style.borderLeftColor = group.color;
            }
            card.onclick = () => selectGroup(group.id);

            const colorStyle = group.color ? `background: ${group.color};` : "";

            card.innerHTML = `
              <div class="group-card-header">
                <span class="group-card-name">${group.name}</span>
                <div style="display: flex; gap: 5px; align-items: center">
                  ${group.color ? `<div class="group-card-color" style="${colorStyle}"></div>` : ""}
                  <button class="btn btn-small" style="padding: 4px 8px; font-size: 11px; background: #f3f4f6; color: #333" onclick="event.stopPropagation(); showEditGroupModal(${
                    group.id
                  })" title="ìˆ˜ì •">
                    âœï¸
                  </button>
                  <button class="btn btn-small" style="padding: 4px 8px; font-size: 11px; background: #fee2e2; color: #991b1b" onclick="event.stopPropagation(); deleteGroup(${
                    group.id
                  })" title="ì‚­ì œ">
                    ğŸ—‘ï¸
                  </button>
                </div>
              </div>
              ${group.description ? `<div class="group-card-description">${group.description}</div>` : ""}
              <div class="group-card-keywords-count">í‚¤ì›Œë“œ: <span id="group-${group.id}-count">0</span>ê°œ</div>
            `;

            groupsList.appendChild(card);
            loadGroupKeywordsCount(group.id);
          });
        } catch (error) {
          console.error("ê·¸ë£¹ ë¡œë“œ ì‹¤íŒ¨:", error);
          showError("ê·¸ë£¹ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      async function loadGroupKeywordsCount(groupId) {
        try {
          const response = await fetch(`/api/labels/groups/${groupId}/keywords`);
          const keywords = await response.json();
          const countElement = document.getElementById(`group-${groupId}-count`);
          if (countElement) {
            countElement.textContent = keywords.length;
          }
        } catch (error) {
          console.error("ê·¸ë£¹ í‚¤ì›Œë“œ ìˆ˜ ë¡œë“œ ì‹¤íŒ¨:", error);
        }
      }

      async function loadKeywords() {
        try {
          // í‚¤ì›Œë“œì™€ ê·¸ë£¹ ëª©ë¡ì„ ë™ì‹œì— ë¡œë“œ
          const [keywordsResponse, groupsResponse] = await Promise.all([fetch("/api/labels?label_type=keyword"), fetch("/api/labels/groups")]);

          const keywords = await keywordsResponse.json();
          const groups = await groupsResponse.json();

          // ê·¸ë£¹ ID -> ê·¸ë£¹ ì´ë¦„ ë§¤í•‘ ìƒì„±
          const groupMap = new Map();
          groups.forEach((group) => {
            groupMap.set(group.id, group.name);
          });

          const keywordsList = document.getElementById("keywords-list");
          if (!keywordsList) return;
          keywordsList.innerHTML = "";

          // ê·¸ë£¹ì´ ì„ íƒëœ ê²½ìš° í‚¤ì›Œë“œë¥¼ ë¶„ë¥˜
          let groupKeywords = [];
          let otherKeywords = [];

          if (selectedGroupId) {
            keywords.forEach((keyword) => {
              if (keyword.parent_label_id === selectedGroupId) {
                groupKeywords.push(keyword);
              } else {
                otherKeywords.push(keyword);
              }
            });

            // ê·¸ë£¹ í‚¤ì›Œë“œ ì„¹ì…˜
            if (groupKeywords.length > 0) {
              const sectionTitle = document.createElement("div");
              sectionTitle.style.cssText = "width: 100%; font-weight: 600; color: #2563eb; margin-bottom: 8px; margin-top: 10px; font-size: 14px";
              sectionTitle.textContent = "ê·¸ë£¹ í‚¤ì›Œë“œ";
              keywordsList.appendChild(sectionTitle);
            }

            groupKeywords.forEach((keyword) => {
              const badge = createKeywordBadge(keyword, true);
              keywordsList.appendChild(badge);
            });

            // ê·¸ë£¹ ì™¸ í‚¤ì›Œë“œ ì„¹ì…˜
            if (otherKeywords.length > 0) {
              const sectionTitle = document.createElement("div");
              sectionTitle.style.cssText = "width: 100%; font-weight: 600; color: #6b7280; margin-bottom: 8px; margin-top: 15px; font-size: 14px";
              sectionTitle.textContent = "ê·¸ë£¹ ì™¸ í‚¤ì›Œë“œ";
              keywordsList.appendChild(sectionTitle);
            }

            otherKeywords.forEach((keyword) => {
              const badge = createKeywordBadge(keyword, false);
              keywordsList.appendChild(badge);
            });
          } else {
            // ê·¸ë£¹ì´ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° ëª¨ë“  í‚¤ì›Œë“œë¥¼ ë¹„í™œì„±í™” ìƒíƒœë¡œ í‘œì‹œ
            keywords.forEach((keyword) => {
              const badge = createKeywordBadge(keyword, false);
              keywordsList.appendChild(badge);
            });
          }
        } catch (error) {
          console.error("í‚¤ì›Œë“œ ë¡œë“œ ì‹¤íŒ¨:", error);
          showError("í‚¤ì›Œë“œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      function createKeywordBadge(keyword, isInGroup) {
        const badge = document.createElement("span");
        badge.className = isInGroup ? "keyword-badge active" : "keyword-badge inactive";
        badge.dataset.keywordId = keyword.id;
        badge.textContent = keyword.name;
        badge.style.cursor = "pointer";

        badge.onclick = () => {
          if (selectedGroupId) {
            toggleKeywordSelection(keyword.id);
          }
        };

        return badge;
      }

      // ë§¤ì¹­ ëª¨ë“œëŠ” ìƒì‹œ í™œì„±í™”ì´ë¯€ë¡œ ì´ í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ
      // function toggleMatchingMode() { ... } ì œê±°ë¨

      function updateKeywordCardsInteraction() {
        // ëª¨ë“  í‚¤ì›Œë“œ ë°°ì§€ì˜ ìƒí˜¸ì‘ìš© ìƒíƒœ ì—…ë°ì´íŠ¸ (ë§¤ì¹­ ëª¨ë“œëŠ” ìƒì‹œ í™œì„±í™”)
        document.querySelectorAll(".keyword-badge").forEach((badge) => {
          badge.style.cursor = selectedGroupId ? "pointer" : "default";
          badge.style.opacity = selectedGroupId ? "1" : "0.6";
        });
      }

      function selectGroup(groupId) {
        selectedGroupId = selectedGroupId === groupId ? null : groupId;
        if (selectedGroupId) {
          // ê·¸ë£¹ ì„ íƒ ì‹œ í‚¤ì›Œë“œ ì„ íƒ ì´ˆê¸°í™”
          selectedKeywordIds.clear();
        }
        // í‚¤ì›Œë“œ ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ê·¸ë£¹ë³„ë¡œ ë¶„ë¥˜ í‘œì‹œ
        loadKeywords();
        updateMatchingUI();
      }

      function toggleKeywordSelection(keywordId) {
        if (!selectedGroupId) {
          showError("ë¨¼ì € ì¢Œì¸¡ì—ì„œ ê·¸ë£¹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }
        if (selectedKeywordIds.has(keywordId)) {
          selectedKeywordIds.delete(keywordId);
        } else {
          selectedKeywordIds.add(keywordId);
        }
        updateMatchingUI();
      }

      function updateMatchingUI() {
        document.querySelectorAll(".group-card").forEach((card) => {
          if (card.dataset.groupId == selectedGroupId) {
            card.classList.add("selected");
          } else {
            card.classList.remove("selected");
          }
        });

        document.querySelectorAll(".keyword-badge").forEach((badge) => {
          const keywordId = parseInt(badge.dataset.keywordId);
          if (selectedKeywordIds.has(keywordId)) {
            badge.classList.add("selected");
            badge.classList.remove("active", "inactive");
          } else {
            badge.classList.remove("selected");
            // ê¸°ë³¸ ìƒíƒœë¡œ ë³µì› (í™œì„±í™”/ë¹„í™œì„±í™”ëŠ” ì¶”í›„ ê·¸ë£¹ ì„ íƒ ì‹œ ê²°ì •)
            if (!badge.classList.contains("active") && !badge.classList.contains("inactive")) {
              badge.classList.add("inactive");
            }
          }
        });

        const summaryBar = document.getElementById("matching-summary-bar");
        const summaryText = document.getElementById("selection-summary");

        if (summaryBar && summaryText) {
          // ê·¸ë£¹ì´ ì„ íƒë˜ë©´ ìš”ì•½ ë°” í‘œì‹œ (ë§¤ì¹­ ëª¨ë“œëŠ” ìƒì‹œ í™œì„±í™”)
          if (selectedGroupId) {
            summaryBar.style.display = "block";
            // ê·¸ë£¹ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
            const selectedGroupCard = document.querySelector(`.group-card[data-group-id="${selectedGroupId}"]`);
            const groupName = selectedGroupCard ? selectedGroupCard.querySelector(".group-card-name")?.textContent : `ê·¸ë£¹ #${selectedGroupId}`;

            if (selectedKeywordIds.size > 0) {
              summaryText.textContent = `ì„ íƒëœ ê·¸ë£¹: ${groupName} Â· ì„ íƒëœ í‚¤ì›Œë“œ: ${selectedKeywordIds.size}ê°œ`;
            } else {
              summaryText.textContent = `ì„ íƒëœ ê·¸ë£¹: ${groupName} Â· ìš°ì¸¡ì—ì„œ í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ì„¸ìš”`;
            }
          } else {
            summaryBar.style.display = "none";
          }
        }
      }

      function clearSelection() {
        selectedGroupId = null;
        selectedKeywordIds.clear();
        updateMatchingUI();
      }

      async function applyGroupKeywords() {
        if (!selectedGroupId || selectedKeywordIds.size === 0) {
          showError("ê·¸ë£¹ê³¼ í‚¤ì›Œë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        try {
          const response = await fetch(`/api/labels/groups/${selectedGroupId}/keywords`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              keyword_ids: Array.from(selectedKeywordIds),
            }),
          });

          if (!response.ok) {
            throw new Error("í‚¤ì›Œë“œ ì—°ê²° ì‹¤íŒ¨");
          }

          showSuccess(`${selectedKeywordIds.size}ê°œì˜ í‚¤ì›Œë“œê°€ ê·¸ë£¹ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          clearSelection();
          loadGroups();
          loadKeywords();
        } catch (error) {
          console.error("í‚¤ì›Œë“œ ì—°ê²° ì‹¤íŒ¨:", error);
          showError("í‚¤ì›Œë“œ ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      function searchGroupsAndKeywords() {
        const searchTerm = document.getElementById("group-search-input")?.value.toLowerCase() || "";
        document.querySelectorAll(".group-card, .keyword-badge").forEach((card) => {
          const text = card.textContent.toLowerCase();
          card.style.display = text.includes(searchTerm) ? "inline-flex" : "none";
        });
      }

      let editingGroupId = null;

      function showCreateGroupModal() {
        editingGroupId = null;
        const modal = document.getElementById("create-group-modal");
        const title = document.getElementById("group-modal-title");
        const submitBtn = document.getElementById("group-submit-btn");

        if (modal) {
          modal.style.display = "flex";
          title.textContent = "ìƒˆ í‚¤ì›Œë“œ ê·¸ë£¹ ìƒì„±";
          submitBtn.textContent = "ìƒì„±";

          // í¼ ì´ˆê¸°í™”
          document.getElementById("create-group-form").reset();
          document.getElementById("suggested-keywords-container").style.display = "none";
          selectedSuggestedKeywords.clear();
          // ì—ëŸ¬/ì„±ê³µ ë©”ì‹œì§€ ì´ˆê¸°í™” (ì‹œë‚˜ë¦¬ì˜¤ 2 ê°œì„ )
          const errorDiv = document.getElementById("keyword-suggestion-error");
          const successDiv = document.getElementById("keyword-suggestion-success");
          if (errorDiv) {
            errorDiv.style.display = "none";
            errorDiv.textContent = "";
          }
          if (successDiv) {
            successDiv.style.display = "none";
            successDiv.textContent = "";
          }
          document.getElementById("group-name-input").focus();

          // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
          modal.onclick = (e) => {
            if (e.target === modal) {
              closeCreateGroupModal();
            }
          };
        }
      }

      async function showEditGroupModal(groupId) {
        try {
          const response = await fetch(`/api/labels/groups/${groupId}`);
          if (!response.ok) throw new Error("ê·¸ë£¹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");

          const group = await response.json();
          editingGroupId = groupId;

          const modal = document.getElementById("create-group-modal");
          const title = document.getElementById("group-modal-title");
          const submitBtn = document.getElementById("group-submit-btn");

          modal.style.display = "flex";
          title.textContent = "í‚¤ì›Œë“œ ê·¸ë£¹ ìˆ˜ì •";
          submitBtn.textContent = "ìˆ˜ì •";

          // í¼ì— ê¸°ì¡´ ê°’ ì±„ìš°ê¸°
          document.getElementById("group-name-input").value = group.name || "";
          document.getElementById("group-description-input").value = group.description || "";
          document.getElementById("group-color-input").value = group.color || "";
          document.getElementById("suggested-keywords-container").style.display = "none";
          selectedSuggestedKeywords.clear();
          // ì—ëŸ¬/ì„±ê³µ ë©”ì‹œì§€ ì´ˆê¸°í™” (ì‹œë‚˜ë¦¬ì˜¤ 2 ê°œì„ )
          const errorDiv = document.getElementById("keyword-suggestion-error");
          const successDiv = document.getElementById("keyword-suggestion-success");
          if (errorDiv) {
            errorDiv.style.display = "none";
            errorDiv.textContent = "";
          }
          if (successDiv) {
            successDiv.style.display = "none";
            successDiv.textContent = "";
          }

          modal.onclick = (e) => {
            if (e.target === modal) {
              closeCreateGroupModal();
            }
          };
        } catch (error) {
          console.error("ê·¸ë£¹ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:", error);
          showError("ê·¸ë£¹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      function closeCreateGroupModal() {
        const modal = document.getElementById("create-group-modal");
        if (modal) {
          modal.style.display = "none";
        }
      }

      async function handleCreateGroup(event) {
        event.preventDefault();

        const name = document.getElementById("group-name-input").value.trim();
        const description = document.getElementById("group-description-input").value.trim();
        const color = document.getElementById("group-color-input").value.trim();

        if (!name) {
          showError("ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        // ìƒ‰ìƒ ì½”ë“œ ìœ íš¨ì„± ê²€ì‚¬
        let validColor = null;
        if (color) {
          if (!/^#[0-9A-Fa-f]{6}$/.test(color)) {
            showError("ì˜¬ë°”ë¥¸ ìƒ‰ìƒ ì½”ë“œ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (ì˜ˆ: #4F46E5)");
            return;
          }
          validColor = color;
        }

        if (editingGroupId) {
          await updateGroup(editingGroupId, name, description || null, validColor);
        } else {
          await createGroup(name, description || null, validColor);
        }
        closeCreateGroupModal();
      }

      async function createGroup(name, description, color) {
        try {
          const payload = {
            name: name,
            description: description || null,
            color: color || null,
          };

          const response = await fetch("/api/labels/groups", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || "ê·¸ë£¹ ìƒì„± ì‹¤íŒ¨");
          }

          const result = await response.json();

          // ì¶”ì²œëœ í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ ê·¸ë£¹ì— ìë™ ì—°ê²°
          const suggestedKeywords = Array.from(selectedSuggestedKeywords);
          console.log("ê·¸ë£¹ ìƒì„± ì™„ë£Œ, ì¶”ì²œ í‚¤ì›Œë“œ ì—°ê²° ì‹œë„:", {
            groupId: result.id,
            suggestedKeywords: suggestedKeywords,
            count: suggestedKeywords.length,
          });

          if (suggestedKeywords.length > 0 && result.id) {
            try {
              await addKeywordsToGroup(result.id, suggestedKeywords);
              showSuccess(`ê·¸ë£¹ì´ ìƒì„±ë˜ì—ˆê³  ${suggestedKeywords.length}ê°œì˜ í‚¤ì›Œë“œê°€ ìë™ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (keywordError) {
              console.error("í‚¤ì›Œë“œ ìë™ ì—°ê²° ì‹¤íŒ¨:", keywordError);
              showSuccess("ê·¸ë£¹ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. (í‚¤ì›Œë“œ ìë™ ì—°ê²° ì‹¤íŒ¨)");
            }
          } else {
            showSuccess("ê·¸ë£¹ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
          }

          loadGroups();
          loadKeywords();
        } catch (error) {
          console.error("ê·¸ë£¹ ìƒì„± ì‹¤íŒ¨:", error);
          showError(error.message || "ê·¸ë£¹ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      async function updateGroup(groupId, name, description, color) {
        try {
          const payload = {
            name: name,
            description: description || null,
            color: color || null,
          };

          const response = await fetch(`/api/labels/groups/${groupId}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || "ê·¸ë£¹ ìˆ˜ì • ì‹¤íŒ¨");
          }

          showSuccess("ê·¸ë£¹ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
          loadGroups();
        } catch (error) {
          console.error("ê·¸ë£¹ ìˆ˜ì • ì‹¤íŒ¨:", error);
          showError(error.message || "ê·¸ë£¹ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      async function deleteGroup(groupId) {
        if (!confirm("ì´ ê·¸ë£¹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê·¸ë£¹ì— ì†í•œ í‚¤ì›Œë“œëŠ” ê·¸ë£¹ì—ì„œ í•´ì œë©ë‹ˆë‹¤.")) {
          return;
        }

        try {
          const response = await fetch(`/api/labels/groups/${groupId}`, {
            method: "DELETE",
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || "ê·¸ë£¹ ì‚­ì œ ì‹¤íŒ¨");
          }

          showSuccess("ê·¸ë£¹ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          loadGroups();
          loadKeywords();
        } catch (error) {
          console.error("ê·¸ë£¹ ì‚­ì œ ì‹¤íŒ¨:", error);
          showError(error.message || "ê·¸ë£¹ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      function clearSuggestedKeywords() {
        const container = document.getElementById("suggested-keywords-container");
        const keywordsList = document.getElementById("suggested-keywords-list");

        container.style.display = "none";
        keywordsList.innerHTML = "";
        selectedSuggestedKeywords.clear();
      }

      let selectedSuggestedKeywords = new Set();

      async function suggestKeywordsFromDescription() {
        const description = document.getElementById("group-description-input").value.trim();
        const errorDiv = document.getElementById("keyword-suggestion-error");
        const successDiv = document.getElementById("keyword-suggestion-success");

        // ì—ëŸ¬/ì„±ê³µ ë©”ì‹œì§€ ì´ˆê¸°í™”
        if (errorDiv) {
          errorDiv.style.display = "none";
          errorDiv.textContent = "";
        }
        if (successDiv) {
          successDiv.style.display = "none";
          successDiv.textContent = "";
        }

        if (!description) {
          // ëª¨ë‹¬ ë‚´ë¶€ì— ì—ëŸ¬ í‘œì‹œ (ì‹œë‚˜ë¦¬ì˜¤ 2 ê°œì„ )
          if (errorDiv) {
            errorDiv.textContent = "ì„¤ëª…ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.";
            errorDiv.style.display = "block";
            // ìŠ¤í¬ë¡¤í•˜ì—¬ ì—ëŸ¬ ë©”ì‹œì§€ê°€ ë³´ì´ë„ë¡
            setTimeout(() => {
              errorDiv.scrollIntoView({ behavior: "smooth", block: "nearest" });
            }, 100);
          } else {
            showError("ì„¤ëª…ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
          }
          return;
        }

        const btn = document.getElementById("suggest-keywords-btn");
        const container = document.getElementById("suggested-keywords-container");
        const keywordsList = document.getElementById("suggested-keywords-list");

        btn.disabled = true;
        btn.textContent = "â³ ì¶”ì²œ ì¤‘...";
        container.style.display = "none";
        keywordsList.innerHTML = "";

        try {
          const response = await fetch("/api/labels/groups/suggest-keywords", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ description: description }),
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            const errorMessage = errorData.detail || "í‚¤ì›Œë“œ ì¶”ì²œ ì‹¤íŒ¨";
            throw new Error(errorMessage);
          }

          const data = await response.json();
          const keywords = data.keywords || [];
          const llmKeywords = data.llm_keywords || [];
          const similarKeywords = data.similar_keywords || [];

          if (keywords.length === 0) {
            // ëª¨ë‹¬ ë‚´ë¶€ì— ì—ëŸ¬ í‘œì‹œ (ì‹œë‚˜ë¦¬ì˜¤ 2 ê°œì„ )
            const errorDiv = document.getElementById("keyword-suggestion-error");
            if (errorDiv) {
              errorDiv.textContent = "ì¶”ì²œí•  í‚¤ì›Œë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
              errorDiv.style.display = "block";
              // ìŠ¤í¬ë¡¤í•˜ì—¬ ì—ëŸ¬ ë©”ì‹œì§€ê°€ ë³´ì´ë„ë¡
              setTimeout(() => {
                errorDiv.scrollIntoView({ behavior: "smooth", block: "nearest" });
              }, 100);
            } else {
              showError("ì¶”ì²œí•  í‚¤ì›Œë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
            return;
          }

          // ì—ëŸ¬/ì„±ê³µ ë©”ì‹œì§€ ì´ˆê¸°í™”
          const errorDiv = document.getElementById("keyword-suggestion-error");
          const successDiv = document.getElementById("keyword-suggestion-success");
          if (errorDiv) {
            errorDiv.style.display = "none";
          }
          if (successDiv) {
            successDiv.style.display = "none";
          }

          // í‚¤ì›Œë“œ ëª©ë¡ í‘œì‹œ
          keywordsList.innerHTML = "";
          selectedSuggestedKeywords.clear();

          keywords.forEach((keyword) => {
            const chip = document.createElement("div");
            chip.className = "keyword-chip";
            chip.dataset.keyword = keyword;
            chip.style.cssText =
              "display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: white; border: 2px solid #e5e7eb; border-radius: 16px; cursor: pointer; font-size: 13px; transition: all 0.2s";

            // ìœ ì‚¬ í‚¤ì›Œë“œì¸ì§€ í™•ì¸í•˜ì—¬ ë°°ì§€ í‘œì‹œ
            const isSimilar = similarKeywords.includes(keyword);
            const badge = isSimilar
              ? '<span style="font-size: 10px; background: #fef3c7; color: #92400e; padding: 2px 6px; border-radius: 10px; margin-right: 4px">ìœ ì‚¬</span>'
              : "";

            const keywordText = document.createElement("span");
            keywordText.innerHTML = badge + keyword;
            keywordText.style.flex = "1";
            keywordText.onclick = (e) => {
              e.stopPropagation();
              toggleSuggestedKeyword(keyword, chip);
            };

            const deleteBtn = document.createElement("button");
            deleteBtn.innerHTML = "Ã—";
            deleteBtn.style.cssText =
              "background: none; border: none; color: #666; cursor: pointer; font-size: 16px; line-height: 1; padding: 0; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s";
            deleteBtn.onclick = (e) => {
              e.stopPropagation();
              removeSuggestedKeyword(keyword, chip);
            };
            deleteBtn.onmouseenter = () => {
              deleteBtn.style.background = "#fee2e2";
              deleteBtn.style.color = "#991b1b";
            };
            deleteBtn.onmouseleave = () => {
              deleteBtn.style.background = "none";
              deleteBtn.style.color = "#666";
            };

            chip.appendChild(keywordText);
            chip.appendChild(deleteBtn);
            keywordsList.appendChild(chip);
          });

          container.style.display = "block";

          // LLM í‚¤ì›Œë“œì™€ ìœ ì‚¬ í‚¤ì›Œë“œ êµ¬ë¶„ í‘œì‹œ - ëª¨ë‹¬ ë‚´ë¶€ì— í‘œì‹œ (ì‹œë‚˜ë¦¬ì˜¤ 2 ê°œì„ )
          let message = `${keywords.length}ê°œì˜ í‚¤ì›Œë“œê°€ ì¶”ì²œë˜ì—ˆìŠµë‹ˆë‹¤.`;
          if (llmKeywords.length > 0 && similarKeywords.length > 0) {
            message += ` (LLM: ${llmKeywords.length}ê°œ, ìœ ì‚¬ í‚¤ì›Œë“œ: ${similarKeywords.length}ê°œ)`;
          } else if (similarKeywords.length > 0) {
            message += ` (ìœ ì‚¬ í‚¤ì›Œë“œ: ${similarKeywords.length}ê°œ í¬í•¨)`;
          } else if (llmKeywords.length > 0) {
            message += ` (LLM: ${llmKeywords.length}ê°œ)`;
          }

          // ëª¨ë‹¬ ë‚´ë¶€ì— ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
          const successMsgDiv = document.getElementById("keyword-suggestion-success");
          if (successMsgDiv) {
            successMsgDiv.textContent = message;
            successMsgDiv.style.display = "block";
            // ìŠ¤í¬ë¡¤í•˜ì—¬ ì„±ê³µ ë©”ì‹œì§€ê°€ ë³´ì´ë„ë¡
            setTimeout(() => {
              successMsgDiv.scrollIntoView({ behavior: "smooth", block: "nearest" });
            }, 100);
          } else {
            // í´ë°±: ëª¨ë‹¬ ì™¸ë¶€ì— í‘œì‹œ
            showSuccess(message);
          }
        } catch (error) {
          console.error("í‚¤ì›Œë“œ ì¶”ì²œ ì‹¤íŒ¨:", error);
          // ëª¨ë‹¬ ë‚´ë¶€ì— ì—ëŸ¬ í‘œì‹œ (ì‹œë‚˜ë¦¬ì˜¤ 2 ê°œì„ )
          const errorDiv = document.getElementById("keyword-suggestion-error");
          if (errorDiv) {
            errorDiv.textContent = error.message || "í‚¤ì›Œë“œ ì¶”ì²œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            errorDiv.style.display = "block";
            // ìŠ¤í¬ë¡¤í•˜ì—¬ ì—ëŸ¬ ë©”ì‹œì§€ê°€ ë³´ì´ë„ë¡
            setTimeout(() => {
              errorDiv.scrollIntoView({ behavior: "smooth", block: "nearest" });
            }, 100);
          } else {
            // í´ë°±: ëª¨ë‹¬ ì™¸ë¶€ì— í‘œì‹œ
            showError(error.message || "í‚¤ì›Œë“œ ì¶”ì²œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        } finally {
          btn.disabled = false;
          btn.textContent = "ğŸ’¡ ì„¤ëª… ê¸°ë°˜ í‚¤ì›Œë“œ ì¶”ì²œ";
        }
      }

      function toggleSuggestedKeyword(keyword, chip) {
        if (selectedSuggestedKeywords.has(keyword)) {
          selectedSuggestedKeywords.delete(keyword);
          chip.style.background = "white";
          chip.style.borderColor = "#e5e7eb";
        } else {
          selectedSuggestedKeywords.add(keyword);
          chip.style.background = "#eff6ff";
          chip.style.borderColor = "#2563eb";
        }
      }

      function removeSuggestedKeyword(keyword, chip) {
        // ì„ íƒ í•´ì œ
        selectedSuggestedKeywords.delete(keyword);

        // DOMì—ì„œ ì œê±°
        chip.remove();

        // ëª¨ë“  í‚¤ì›Œë“œê°€ ì œê±°ë˜ì—ˆìœ¼ë©´ ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸°
        const keywordsList = document.getElementById("suggested-keywords-list");
        if (keywordsList && keywordsList.children.length === 0) {
          document.getElementById("suggested-keywords-container").style.display = "none";
        }
      }

      async function addKeywordsToGroup(groupId, keywordNames) {
        try {
          // í‚¤ì›Œë“œ ì´ë¦„ ë°°ì—´ ì •ë¦¬ (ê³µë°± ì œê±°, ë¹ˆ ê°’ ì œê±°, ì¤‘ë³µ ì œê±°)
          const cleanedKeywords = Array.from(
            new Set(
              Array.from(keywordNames)
                .map((k) => (typeof k === "string" ? k.trim() : String(k).trim()))
                .filter((k) => k.length > 0)
            )
          );

          if (cleanedKeywords.length === 0) {
            showError("ì¶”ê°€í•  í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const response = await fetch(`/api/labels/groups/${groupId}/keywords`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ keyword_names: cleanedKeywords }),
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || "í‚¤ì›Œë“œ ì¶”ê°€ ì‹¤íŒ¨");
          }

          const result = await response.json();

          // ê²°ê³¼ ë©”ì‹œì§€ êµ¬ì„±
          let message = `${result.added_count || cleanedKeywords.length}ê°œì˜ í‚¤ì›Œë“œê°€ ê·¸ë£¹ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`;
          if (result.skipped_count > 0) {
            message += ` (${result.skipped_count}ê°œëŠ” ì´ë¯¸ ê·¸ë£¹ì— ì†í•¨)`;
          }

          // ì—ëŸ¬ê°€ ìˆìœ¼ë©´ ê²½ê³  í‘œì‹œ
          if (result.errors && result.errors.length > 0) {
            console.warn("í‚¤ì›Œë“œ ì¶”ê°€ ê²½ê³ :", result.errors);
            showError(`ì¼ë¶€ í‚¤ì›Œë“œ ì¶”ê°€ ì‹¤íŒ¨ (${result.error_count}ê°œ): ${result.errors.slice(0, 3).join(", ")}${result.errors.length > 3 ? "..." : ""}`);
          } else {
            showSuccess(message);
          }

          // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          loadGroups();
          loadKeywords();
        } catch (error) {
          console.error("í‚¤ì›Œë“œ ì¶”ê°€ ì‹¤íŒ¨:", error);
          showError(error.message || "í‚¤ì›Œë“œ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }
    </script>
  </body>
</html>
