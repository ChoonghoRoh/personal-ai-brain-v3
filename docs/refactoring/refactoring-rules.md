# 리팩토링 규정 (Rules Index)

**버전**: 1.0
**최종 수정**: 2026-02-21
**참조**: [3-workflow.md §10](../SSOT/renewal/iterations/4th/3-workflow.md#10-코드-유지관리-리팩토링)

---

## 1. 용어 정의

| 용어 | 정의 |
|------|------|
| **단일 파일 줄 수** | 빈 줄·주석 포함 전체 줄 수 (`wc -l` 기준) |
| **개발 파일** | *.py, *.js, *.css, *.html (테스트·설정·문서 제외) |
| **연관 파일** | import/호출/include 관계로 직접 연결된 개발 파일 |
| **밀접 파일** | 연관 파일 중 양방향 참조 또는 공유 상태가 있는 파일 |

---

## 2. 임계값

| 기준 | 줄 수 | 의미 |
|------|------:|------|
| 관심선 | **500줄** | 레지스트리 등록, 모니터링 시작 |
| 경고선 | **700줄** | 리팩토링 검토 대상, Level 분류 |
| 위험선 | **1000줄** | 즉시 리팩토링 대상 (다음 Master Plan 최우선) |

---

## 3. Level 분류

### 3.1 Lv1 — 단일 파일 분리

| 항목 | 기준 |
|------|------|
| 조건 | 700줄 초과 파일이 **독립적으로 분리 가능** |
| 판별 | 해당 파일의 연관 파일 중 500줄 초과가 **0개** |
| 작업 규모 | 대상 파일 1개, 변경 파일 1~3개 |
| 편성 | 다음 Master Plan 내 **선행 sub-phase**로 처리 |

### 3.2 Lv2 — 연관 파일 재설계

| 항목 | 기준 |
|------|------|
| 조건 | 700줄 초과 파일의 연관 파일 중 500줄 초과가 **1개 이상** + 양방향 참조 |
| 판별 | import 그래프 스캔으로 자동 탐지 |
| 작업 규모 | 대상 파일 2개+, 변경 범위 미확정 (영향도 조사 필요) |
| 편성 | `phase-X-refactoring` 별도 Phase로 진행 |

### 3.3 자동 판별 기준

```
700줄 초과 파일 발견
  │
  ▼
해당 파일의 import/호출 대상 파일 목록 스캔
  │
  ▼
그 중 500줄 초과 파일이 있는가?
  │
  ├── 없음 → Lv1
  └── 있음 → 해당 파일도 역방향 참조하는가?
                │
                ├── 단방향만 → Lv1 (분리해도 영향 제한적)
                └── 양방향 (밀접) → Lv2
```

---

## 4. Lv1 프로세스

```
[1] 레지스트리 Lv1 등록
  │
  ▼
[2] 다음 Master Plan 작성 시 선행 sub-phase로 편성
  │
  ▼
[3] 구현 — 파일 분리
  │   → 클래스/함수 단위, 응집도 기반 분리
  │   → 분리 후 각 파일 500줄 이하 목표
  │
  ▼
[4] 검증 — 기존 테스트 통과 + import 정상
  │
  ▼
[5] 레지스트리 갱신 (상태: 해소)
```

---

## 5. Lv2 프로세스

### 5.1 영향도 조사 (Master Plan 수립 전 선행)

```
[1] 대상 파일 기준 import/호출 그래프 전체 매핑
  │   → 500줄 초과 연관 파일 모두 포함
  │   → 2차 연관 (연관 파일의 연관 파일)까지 탐색
  │
  ▼
[2] 산출물: 영향도 리포트
      ├ 파일 목록 + 줄 수
      ├ 의존성 방향 (단방향/양방향)
      └ 변경 시 영향받는 파일 범위
```

### 5.2 아키텍처 검토

```
[3] 현재 구조의 문제점 정의
  │
  ▼
[4] 목표 구조 설계 (단순 분할이 아닌 재배치)
  │   → 분리 후 각 파일 500줄 이하 가능 여부 판단
  │     ├ 가능 → 목표 구조 확정
  │     └ 일부 불가 → [예외] 후보 표기, 사유 기재
```

### 5.3 Plan 수립 → 승인

```
[5] 리팩토링 Plan 수립
  │   → Task 분해 (의존성 순서 반영)
  │   → 단계별 구현 (한 번에 전부 변경 금지)
  │   → 회귀 테스트 범위 정의
  │
  ▼
[6] 사용자 승인
      → 영향도 리포트 + Plan 기반 승인
```

### 5.4 실행 → 검증

```
[7] git branch 생성 (phase-X-refactoring)
  │   → 현재 팀과 분리된 별도 팀 구성
  │
  ▼
[8] 단계별 구현 + 검증
  │   → Task 단위 구현 → 테스트 통과 확인 → 다음 Task
  │   → sub-phase 완료 시마다 main merge (장기 branch 금지)
  │
  ▼
[9] 전체 완료 후 통합 테스트
  │
  ▼
[10] 레지스트리 갱신 (상태: 해소 또는 [예외] 확정)
```

---

## 6. phase-X-refactoring 운영 규칙

| 규칙 | 내용 |
|------|------|
| **명칭** | `phase-X-refactoring` (예: phase-19-refactoring) |
| **git branch** | main에서 분기, sub-phase 단위로 main에 merge |
| **팀 구성** | 현재 기능 개발 팀과 **별도 팀** 구성 |
| **동시 수정 금지** | 리팩토링 대상 파일을 기능 branch에서 수정 금지 |
| **우선순위 판단** | 아래 §6.1 참조 |

### 6.1 우선순위 — 리팩토링 vs 기능 개발

| 조건 | 판정 |
|------|------|
| 리팩토링 대상 파일을 다음 기능 Phase에서 **수정해야 함** | **리팩토링 먼저** (선행 완료 후 기능 개발) |
| 리팩토링 대상 파일과 다음 기능 Phase가 **무관** | **기능 먼저**, 리팩토링 후순위 가능 |

※ merge conflict 위험이 크므로, 판단이 애매할 경우 **리팩토링 먼저**를 기본으로 한다.

---

## 7. [예외] 확정 조건

"분리 불가" 선언은 아래 **3요건을 모두 충족**해야 한다:

| # | 요건 | 설명 |
|---|------|------|
| 1 | 영향도 조사 **실시** | 조사 없이 예외 선언 금지 |
| 2 | 분리 시도 또는 아키텍처 검토에서 **순환 의존/응집도 파괴 입증** | 구두 판단 금지, 근거 필수 |
| 3 | 사용자 **승인** | 개발자 단독 판단 금지 |

예외 확정 시 레지스트리 기재 항목:
- `[예외]` 태그 + Level
- 사유 (1~2문장)
- 영향도 리포트 참조
- 승인일

---

## 8. 초기 개발 시 적용 (REFACTOR-3)

| 시점 | 조치 |
|------|------|
| **PLANNING** | 새 파일 설계 시 500줄 이하로 모듈 분할 계획 |
| **BUILDING** | 구현 중 파일이 500줄 근접 시 분리 검토 (완성 후가 아니라 작성 중에) |
| **VERIFYING (G2)** | 500줄 초과 파일이 있으면 코드 리뷰에서 지적 |

---

## 9. 해소 이력 추적

리팩토링 완료(해소) 후 이력을 추적하여 재발 감지·아키텍처 결정 보존·원본 추적을 보장한다.

### 9.1 해소 이력 기록 (레지스트리)

리팩토링이 완료되면 레지스트리 `해소 이력` 섹션에 **1행**으로 기록한다:

| 필드 | 내용 | 필수 |
|------|------|:----:|
| 원본 파일 | 리팩토링 전 파일명 + 줄 수 | ✅ |
| 결과 파일 | 분리 후 파일명 + 줄 수 + 관계(독립/참조) | ✅ |
| 수행 Phase | `phase-X-refactoring` 또는 `phase-X-Y` | ✅ |
| 해소일 | 리팩토링 완료 날짜 | ✅ |

**관계 표기**:
- `독립` — 다른 결과 파일과 import 없음, 단독 수정 가능
- `참조:파일명` — 해당 파일을 import, 수정 시 함께 확인 필요

### 9.2 재발 감지

Phase X-Y 완료 시 코드 스캔(REFACTOR-1)에서:

1. 500줄 초과 파일이 해소 이력의 **결과 파일**에 해당하는지 확인
2. 해당 시 → `[재발]` 태그 부여 + 원본 이력 참조 기재
3. `[재발]` 파일은 일반 신규보다 **우선 검토** (구조적으로 커지는 경향 신호)

### 9.3 Lv2 아키텍처 결정 기록 (ADR)

Lv2 리팩토링 Phase의 `plan.md`에 **아키텍처 결정 기록(ADR)** 섹션을 필수 포함:

```markdown
## 아키텍처 결정 기록 (ADR)

### 결정: [원본 파일들] → [결과 파일들] 재배치
- 문제: (현재 구조의 문제점)
- 검토한 대안: (검토 후 기각한 방안과 사유)
- 선택 사유: (채택 방안의 근거)
- 제약: (완전 분리 불가한 부분과 이유)
```

레지스트리 해소 이력에는 Phase plan.md **링크만** 기재한다. (중복 기재 금지)

### 9.4 추적 흐름 요약

```
리팩토링 완료
  │
  ▼
[1] 레지스트리 700줄+ 테이블: 상태 → "해소"
  │
  ▼
[2] 해소 이력 테이블에 1행 추가
  │   (원본, 결과 파일+관계, 수행 Phase, 해소일)
  │
  ▼
[3] Lv2인 경우: Phase plan.md에 ADR 작성 확인
  │
  ▼
이후 Phase X-Y 완료 시 코드 스캔
  │
  ▼
[4] 결과 파일이 다시 500줄 초과?
      ├── YES → [재발] 태그 + 우선 검토
      └── NO  → 정상 모니터링
```

---

## 갱신 이력

| 날짜 | 버전 | 내용 |
|------|:----:|------|
| 2026-02-21 | 1.1 | §9 해소 이력 추적 추가 (Before/After, 재발 감지, Lv2 ADR) |
| 2026-02-21 | 1.0 | 초기 규정 수립. Lv1/Lv2 분류, phase-X-refactoring 운영, [예외] 조건 정의 |
