# 통합 테스트 가이드 (공용)

**용도**: 모든 Phase의 통합 테스트 수행 방법·시나리오 작성 규칙·실행 결과 리포트 규정을 정리합니다.

---

## 1. 목적·범위

- **목적**: 각 Phase에서 구축한 기능(DB·API·UI 등)이 연동되어 기대대로 동작하는지 검증합니다.
- **범위**: Phase의 각 Task별 세부 기능에 대해 **Task당 최대 20가지** 통합 테스트 시나리오를 작성하고, 디테일한 수준까지 테스트를 진행합니다.
- **제외**: 단위 테스트·E2E 자동화 도구 도입은 본 가이드 범위 밖입니다(필요 시 별도 정의).

---

## 2. 실행 환경·전제 조건

| 항목         | 내용                                                                                                     |
| ------------ | -------------------------------------------------------------------------------------------------------- |
| **DB**       | 해당 Phase의 마이그레이션·시딩이 적용된 데이터베이스 (PostgreSQL 등).                                    |
| **Backend**  | 해당 Phase의 API가 반영된 백엔드 서버 기동 (FastAPI 등).                                                 |
| **Frontend** | 해당 Phase의 UI가 반영된 웹 서버/정적 파일 서빙.                                                         |
| **전제**     | 해당 Phase의 하위 Task들이 순차적으로 구축 완료된 상태에서 통합 테스트 수행 (예: Phase X-1 → X-2 → X-3). |

---

## 3. 시나리오 작성 규칙

### 3.1 단위

- **Phase·Task 단위**: Phase X-Y별로 시나리오 작성 (예: Phase 9-1, Phase 11-2 등).
- **시나리오 수**: 각 **Task당 최대 20가지**. 세부 기능(CRUD 한 건, 필터 한 종류, 에러 케이스 등)별로 1개 시나리오로 쪼개어 작성 가능.

### 3.2 시나리오 필수 항목

| 항목          | 설명                                 |
| ------------- | ------------------------------------ |
| **ID**        | 시나리오 번호 (예: X-Y-Z-S01 ~ S20). |
| **제목**      | 한 줄 요약.                          |
| **전제 조건** | DB/API/UI 상태, 사전 데이터 등.      |
| **단계**      | 실행 단계 (1, 2, 3 …).               |
| **기대 결과** | 각 단계 또는 최종 기대 결과.         |
| **실제 결과** | 실행 후 기록 (통과/실패, 비고).      |

### 3.3 저장 위치

- 시나리오 문서: `docs/devtest/scenarios/phase-{X-Y}-scenarios.md` 또는 Task별 파일 (예: `phase-{X-Y}-task-{X-Y-Z}-scenarios.md`).

---

## 4. E2E Spec 파일 워크플로우

**webtest 명령 실행 전** E2E spec 파일 존재 여부를 확인하고, 없을 경우 다음 절차를 따릅니다.

### 4.1 E2E Spec 파일 확인

| 항목          | 설명                                                               |
| ------------- | ------------------------------------------------------------------ |
| **파일 위치** | `e2e/phase-{X-Y}.spec.js` (예: `e2e/phase-11-2.spec.js`)           |
| **확인 방법** | `ls -la e2e/phase-{X-Y}.spec.js` 또는 VS Code 파일 탐색기에서 확인 |
| **필수 여부** | webtest.py 스크립트 실행 시 **필수** (없으면 "E2E 스펙 없음" 오류) |

### 4.2 E2E Spec 없을 경우 처리 절차

1. **E2E Spec 파일 생성**
   - Playwright 기반 E2E 테스트 시나리오 작성
   - 기존 spec 파일(`e2e/phase-9-1.spec.js`, `e2e/phase-10-1.spec.js` 등) 참조하여 구조 통일
   - 시나리오 문서(`docs/devtest/scenarios/phase-{X-Y}-scenarios.md`)를 기반으로 테스트 케이스 작성

2. **대체 테스트 방법 사용**
   - E2E spec 생성이 시간이 걸리거나 불가능한 경우 아래 방법 사용:

   | 테스트 대상        | 대체 방법           | 예시                                                                                      |
   | ------------------ | ------------------- | ----------------------------------------------------------------------------------------- |
   | **API 엔드포인트** | curl + JSON 파싱    | `curl -s http://localhost:8001/api/admin/templates \| python3 -c "import sys, json; ..."` |
   | **UI 페이지**      | HTTP 상태 코드 확인 | `curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/admin/settings/templates`   |
   | **데이터베이스**   | psql 직접 쿼리      | `docker compose exec postgres psql -U brain -d knowledge -c "SELECT * FROM templates"`    |

3. **실행 결과 리포트에 문서화**
   - 대체 방법 사용 시 **반드시** 실행 결과 리포트에 기재:
     - E2E spec 파일 부재 사실
     - 사용한 대체 테스트 방법 (curl, HTTP check, psql 등)
     - 향후 E2E spec 생성 필요 여부
   - 예시:

     ```markdown
     ## E2E Spec 상태

     - E2E Spec 파일: ❌ 없음 (`e2e/phase-{X-Y}.spec.js` 미존재)
     - 대체 테스트: curl API 호출 + HTTP 상태 코드 확인
     - 향후 조치: Phase {X-Y} E2E spec 파일 생성 필요 (우선순위: 중)
     ```

### 4.3 webtest 명령 실행 흐름

```
┌─────────────────────────────────────┐
│ E2E spec 파일 확인                  │
│ (e2e/phase-{X-Y}.spec.js)          │
└─────────────┬───────────────────────┘
              │
         존재? │
        ┌─────┴─────┐
        │           │
       YES         NO
        │           │
        │     ┌─────▼─────────────────────┐
        │     │ E2E Spec 생성             │
        │     │ OR                        │
        │     │ 대체 테스트 방법 사용     │
        │     └─────┬─────────────────────┘
        │           │
        │     ┌─────▼─────────────────────┐
        │     │ 실행 결과 리포트에 문서화 │
        │     │ - E2E spec 부재 사실      │
        │     │ - 대체 방법 사용 내역     │
        │     └───────────────────────────┘
        │
   ┌────▼────────────────────────┐
   │ webtest 명령 실행            │
   │ python scripts/webtest.py    │
   │ {phase} {action}             │
   └──────────────────────────────┘
```

---

## 5. 실행 결과 리포트 규정(Task당)

**Task당 실행 후** 다음 항목을 포함한 **실행 결과 리포트**를 작성합니다.

### 5.1 포함 항목

| 항목                   | 설명                                                                                    |
| ---------------------- | --------------------------------------------------------------------------------------- |
| **코드 오류**          | 테스트 중 발생한 오류. **재현 조건**, **로그/메시지**, **스택 트레이스**(가능 시) 기재. |
| **미해결 이슈**        | 테스트 시점에서 미해결인 이슈. **설명**, **우선순위**(상/중/하), **영향 범위** 기재.    |
| **해결된 이슈**        | 테스트 중 발견 후 해결한 이슈. **해결 방법**, **커밋/PR/이슈 참조** 기재.               |
| **시나리오 결과 요약** | 시나리오 ID별 통과/실패 개수, 비고.                                                     |

### 5.2 저장 위치·파일 명명

| 항목           | 규정                                                                                             |
| -------------- | ------------------------------------------------------------------------------------------------ |
| **저장 위치**  | `docs/devtest/reports/` 또는 `docs/phases/phase-{X-Y}/`.                                         |
| **파일 명명**  | `phase-{X-Y}-task-{X-Y-Z}-execution-report.md` (예: `phase-9-1-task-9-1-1-execution-report.md`). |
| **Task별 1건** | 해당 Phase의 각 Task (예: 9-1-1, 9-1-2, 11-1-1, 11-2-1 등)당 1개 리포트 파일.                    |

### 5.3 리포트 템플릿(요약)

```markdown
# Task {X-Y-Z} 실행 결과 리포트

- Task: {X-Y-Z} (태스크명)
- 실행일: YYYY-MM-DD
- 시나리오 수: N개 (통과 / 실패)

## 코드 오류

| 번호 | 재현 조건 | 로그/메시지 | 스택(요약) |
| ---- | --------- | ----------- | ---------- |
| 1    | ...       | ...         | ...        |

## 미해결 이슈

| 번호 | 설명 | 우선순위 | 영향 범위 |
| ---- | ---- | -------- | --------- |
| 1    | ...  | 상/중/하 | ...       |

## 해결된 이슈

| 번호 | 설명 | 해결 방법 | 참조(커밋/PR) |
| ---- | ---- | --------- | ------------- |
| 1    | ...  | ...       | ...           |

## 시나리오 결과 요약

(시나리오 ID별 통과/실패)
```

---

## 6. 적용 예시

**Phase X-Y 통합 테스트 적용 시 절차:**

1. **Phase Plan 문서** (`docs/phases/phase-{X-Y}/phase-{X-Y}-0-plan.md`) 확인
2. **Task 목록** 및 의존성 파악
3. **시나리오 문서** 작성 (`docs/devtest/scenarios/phase-{X-Y}-scenarios.md`)
4. **E2E Spec 파일** 확인 또는 생성 (`e2e/phase-{X-Y}.spec.js`)
5. **통합 테스트 실행** (webtest 명령 또는 대체 방법)
6. **실행 결과 리포트** 작성 (`docs/devtest/reports/phase-{X-Y}-task-{X-Y-Z}-execution-report.md`)

---

## 7. 참고

- [ai-execution-workflow.md](../ai-execution-workflow.md) — AI 실행 가이드 (검증 단계 포함)
- [phase-unit-user-test-guide.md](./phase-unit-user-test-guide.md) — 웹 테스트 수행 가이드
- Phase별 Plan 문서: `docs/phases/phase-{X-Y}/phase-{X-Y}-0-plan.md`
- Phase별 Todo 문서: `docs/phases/phase-{X-Y}/phase-{X-Y}-0-todo-list.md`
