# Phase 18 Master Plan: 지식 구조 고도화 + 검색 품질 개선

> **상태**: DRAFT (검수 후 확정 예정)
> **작성일**: 2026-02-20
> **선행 조건**: Phase 17 체인 완료 (17-1 ~ 17-8)

---

## 목표

1. **지식 구조를 계층적 트리로 확장** — 현재 라벨(keyword) 트리만 구현된 상태에서, 문서·청크·관계까지 포괄하는 통합 지식 트리 구조 도입
2. **검색 품질 개선** — 키워드/시맨틱/하이브리드 검색 간 일관성 확보 + 결과 차별화 UX
3. **관계 매칭 고도화** — 추천 관계 알고리즘을 Qdrant 벡터 유사도 기반으로 고도화

---

## 현재 상태 (AS-IS)

### 지식 구조
```
Project (프로젝트)         ← 플랫 목록, 계층 없음
 └── Document (문서)       ← 플랫 목록, 폴더 경로만 존재
      └── Chunk (청크)     ← 문서 내 순서(chunk_index)만
           ├── Label (라벨)  ← ✅ 트리 구현 완료 (Phase 17-8)
           └── Relation (관계) ← 플랫 엣지 목록
```

### 검색
- 키워드 검색: PostgreSQL ILIKE + `approved`/`draft` 필터
- 시맨틱 검색: Qdrant 벡터 유사도 (status 필터 없음)
- 하이브리드: RRF 융합
- **문제**: 모드 간 결과 차이가 UI에서 구분되지 않음

### 관계 매칭
- 추천 관계: Qdrant 벡터 유사도 1차 → DB fallback 2차 (핫픽스 적용)
- **문제**: 추천 품질·정밀도 개선 여지 있음

---

## 변경 계획 (TO-BE)

### Phase 18-1: 문서 폴더 트리 구조

**목표**: 문서를 폴더/디렉토리 형태의 트리로 조회·탐색

| Task | 내용 | 도메인 |
|------|------|--------|
| 18-1-1 | Document 폴더 계층 API (file_path 기반 가상 트리 생성) | [BE] |
| 18-1-2 | 폴더 트리뷰 UI 컴포넌트 (접기/펼치기 + 파일 클릭) | [FE] |
| 18-1-3 | Knowledge Studio 폴더 내비게이션 연동 | [FE] |

**참고**: DB 스키마 변경 최소화 — `file_path`에서 폴더 구조를 파싱하여 가상 트리 생성 방식 우선 검토

### Phase 18-2: 통합 지식 트리 뷰

**목표**: Project → 폴더 → Document → Chunk → Label 을 하나의 트리로 조회

| Task | 내용 | 도메인 |
|------|------|--------|
| 18-2-1 | 통합 지식 트리 API (Project/폴더/Document/Chunk 계층) | [BE] |
| 18-2-2 | 통합 트리뷰 페이지 또는 사이드 패널 UI | [FE] |
| 18-2-3 | Breadcrumb 전역 네비게이션 (Project → 폴더 → 문서 → 청크) | [FE] |

### Phase 18-3: 검색 품질 개선

**목표**: 검색 모드 간 일관성 + 결과 차별화 UX

| Task | 내용 | 도메인 |
|------|------|--------|
| 18-3-1 | 시맨틱 검색에도 status 필터 적용 (Qdrant filter 활용) | [BE] |
| 18-3-2 | 검색 결과 UI 차별화 (모드별 배지/점수 의미 표시) | [FE] |
| 18-3-3 | 검색 결과 snippet 품질 개선 (하이라이트 + 컨텍스트 확장) | [FS] |
| 18-3-4 | 검색 모드 설명 툴팁 + 빈 결과 안내 개선 | [FE] |

### Phase 18-4: 관계 추천 고도화

**목표**: 벡터 유사도 기반 cross-document 관계 추천 + 관계 카테고리화

| Task | 내용 | 도메인 |
|------|------|--------|
| 18-4-1 | Qdrant point ID 기반 실제 벡터 유사도 검색 (cross-document) | [BE] |
| 18-4-2 | 관계 타입 자동 분류 (similar/prerequisite/extends/contradicts) | [BE] |
| 18-4-3 | 추천 관계 UI 리디자인 (점수·타입·소스 표시) | [FE] |

---

## Phase 체인 구조

| Phase | 내용 | 예상 Task | 의존성 |
|-------|------|:---------:|--------|
| 18-1 | 문서 폴더 트리 구조 | 3 | 독립 |
| 18-2 | 통합 지식 트리 뷰 | 3 | 18-1 |
| 18-3 | 검색 품질 개선 | 4 | 독립 (18-1/18-2 병행 가능) |
| 18-4 | 관계 추천 고도화 | 3 | 독립 (18-3 병행 가능) |

```
18-1 ──→ 18-2
18-3 (독립)
18-4 (독립)
```

## 마일스톤

- **M1**: 18-1 완료 (문서 폴더 트리)
- **M2**: 18-2 완료 (통합 지식 트리)
- **M3**: 18-3 + 18-4 완료 (검색 + 관계 품질)

---

## 기술 검토 사항

### 폴더 트리 구현 방식 (18-1)
- **방안 A**: `file_path` 파싱 → 가상 폴더 트리 (DB 변경 없음)
- **방안 B**: `Folder` 테이블 신규 생성 → 실제 폴더 엔티티 관리
- **권장**: 방안 A 우선 적용 후 필요시 B로 전환

### 검색 일관성 (18-3)
- Qdrant filter에 `status` 필드 추가 필요 (payload 필터)
- 현재 Qdrant에 status가 payload로 저장되어 있는지 확인 필요
- 없으면 임베딩 재생성 시 status 포함하도록 파이프라인 수정

### 관계 추천 (18-4)
- `qdrant_client.search(vector=chunk_vector)` 직접 호출 방식
- cross-document 검색으로 범위 확장
- LLM 기반 관계 타입 자동 분류 (similar vs prerequisite vs extends)

---

## 참조

- [Phase 17 Chain](../phase-chain-17.md)
- [Phase 17-8 트리 구조](../phase-17-8/phase-17-8-plan.md)
- [SSOT Phase Chain Protocol](../SSOT/renewal/iterations/4th/3-workflow.md#8-phase-chain-자동-순차-실행)

---

> **TODO** (검수 시 추가 작성 예정):
> - [ ] 각 Phase 세부 Task 스펙 구체화
> - [ ] DB 스키마 변경 필요 여부 최종 확인
> - [ ] Qdrant payload 현황 조사 (status 필드 포함 여부)
> - [ ] UI 와이어프레임 / 레이아웃 설계
> - [ ] 우선순위 재조정 (사용자 피드백 반영)
