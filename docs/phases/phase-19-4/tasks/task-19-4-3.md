# Task 19-4-3: 승인 탭 통합

> **도메인**: [FE]
> **담당**: frontend-dev
> **의존성**: 19-4-1 (스캐폴딩 완료 필요)
> **예상 줄 수**: JS ~150, HTML 마크업 ~60

---

## 1. 목표

기존 `/admin/approval` 페이지의 승인 기능을 통합 페이지의 "승인" 탭으로 이식한다. 다중 선택(체크박스) + 일괄 승인 + "전체 승인+라벨" 버튼을 추가한다.

---

## 2. 구현 단계

### 2.1 ApprovalTab 클래스 생성

**파일**: `web/public/js/admin/kw-tab-approval.js` (신규, ~150줄)

기존 `ChunkApprovalManager` 클래스를 **직접 재사용** (복사하지 않음):

```javascript
class ApprovalTab {
  constructor() {
    this.workflow = null;
    this.container = null;
    this.manager = null;  // ChunkApprovalManager 인스턴스
    this.selectedChunkIds = new Set();  // 다중 선택용
  }

  init(container, workflow) {
    this.container = container;
    this.workflow = workflow;

    // 기존 ChunkApprovalManager를 통합 페이지용 DOM ID로 초기화
    this.manager = new ChunkApprovalManager({
      enablePagination: true,
      limit: 20,
      chunkListId: 'kw-approval-chunk-list',
      detailBodyId: 'kw-approval-detail-body',
      detailPlaceholderId: 'kw-approval-detail-placeholder',
      detailContentId: 'kw-approval-detail-content',
      onChunkChange: () => this.updateBulkToolbar(),
    });

    // 전역 호환성 (기존 onclick 핸들러용)
    window.approvalManager = this.manager;

    this.bindEvents();
  }

  activate() {
    this.manager.loadPendingChunks();
  }

  deactivate() { /* no-op */ }

  refresh() {
    this.manager.loadPendingChunks();
  }

  onTabEvent(fromTab, event) {
    if (event.type === 'chunks_created') {
      this.refresh();
    }
  }

  // 다중 선택 관련
  toggleChunkSelection(chunkId) { ... }
  selectAllVisible() { ... }
  deselectAll() { ... }
  updateBulkToolbar() { ... }

  // 선택 청크 일괄 승인
  async batchApproveSelected() { ... }

  // 전체 승인 + 라벨 탭 전환
  async approveAllAndGoManage() { ... }

  bindEvents() { ... }
}
```

### 2.2 다중 선택 기능

기존 `ChunkApprovalManager.displayPendingChunks()`는 청크 카드에 체크박스가 없다. 두 가지 접근:

**접근 A** (권장): `displayPendingChunks()` 호출 후 DOM 후처리로 체크박스 삽입
```javascript
afterDisplayChunks() {
  const cards = this.container.querySelectorAll('.approval-chunk-card');
  cards.forEach(card => {
    const chunkId = parseInt(card.dataset.chunkId, 10);
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.className = 'kw-bulk-check';
    checkbox.checked = this.selectedChunkIds.has(chunkId);
    checkbox.addEventListener('change', () => this.toggleChunkSelection(chunkId));
    card.prepend(checkbox);
  });
}
```

**접근 B**: `ChunkApprovalManager`를 상속하여 `displayPendingChunks()` 오버라이드
-> 기존 클래스 수정을 피하므로 접근 A 권장.

### 2.3 일괄 승인 + 관리 탭 전환

```javascript
async approveAllAndGoManage() {
  const draftIds = this.manager.pendingChunks
    .filter(c => (c.status || '') === 'draft')
    .map(c => c.id);

  if (draftIds.length === 0) {
    showError('승인할 대기 중 청크가 없습니다.');
    return;
  }

  if (!confirm(`대기 중 청크 ${draftIds.length}개를 모두 승인하고 라벨 관리로 이동하시겠습니까?`)) return;

  try {
    await batchApproveChunksApi(draftIds);
    showSuccess(`${draftIds.length}개 청크가 승인되었습니다. 관리 탭으로 이동합니다.`);
    this.workflow.notifyTabChange('approval', { type: 'chunks_approved', count: draftIds.length });
    this.workflow.switchTab('manage');
  } catch (e) {
    showError(e.message || '일괄 승인 중 오류');
  }
}
```

### 2.4 HTML 마크업

**파일**: `web/src/pages/admin/knowledge-workflow.html`

`#tab-approval` 영역:
```html
<div class="kw-approval-layout">
  <!-- 좌측: 청크 목록 -->
  <div class="kw-approval-left">
    <div class="approval-toolbar">
      <div class="approval-status-filters">
        <!-- 상태 필터 버튼 -->
      </div>
      <div class="kw-bulk-toolbar" id="kw-approval-bulk-toolbar" style="display:none">
        <span id="kw-approval-selected-count">0개 선택</span>
        <button class="btn btn-success btn-small" id="kw-approval-btn-approve-selected">선택 승인</button>
      </div>
      <button class="btn btn-success btn-small" id="kw-approval-btn-approve-all">전체 승인</button>
      <button class="btn btn-primary btn-small" id="kw-approval-btn-approve-and-label">전체 승인+라벨</button>
    </div>
    <div id="kw-approval-chunk-list" class="approval-chunk-list">
      <div class="loading">청크 목록을 불러오는 중...</div>
    </div>
    <div id="kw-approval-pagination" class="approval-pagination" style="display:none">
      <!-- 페이지네이션 -->
    </div>
  </div>
  <!-- 우측: 청크 상세 -->
  <div class="kw-approval-right">
    <h3>청크 상세</h3>
    <div id="kw-approval-detail-body">
      <div id="kw-approval-detail-placeholder" class="approval-detail-placeholder">
        청크를 선택하면 상세 내용이 표시됩니다.
      </div>
      <div id="kw-approval-detail-content" style="display:none"></div>
    </div>
  </div>
</div>
```

---

## 3. 수정/생성 파일 목록

| 구분 | 파일 | 작업 |
|------|------|------|
| 신규 | `web/public/js/admin/kw-tab-approval.js` | ApprovalTab 클래스 |
| 수정 | `web/src/pages/admin/knowledge-workflow.html` | #tab-approval 마크업 추가 |

---

## 4. Done Definition

- [ ] 승인 탭 활성화 시 승인 대기 목록 자동 로드
- [ ] 상태 필터 (대기중/승인됨/거절됨) 동작
- [ ] 청크 카드 클릭 시 우측 상세 표시
- [ ] 상세에서 승인/거절 동작
- [ ] 상세에서 AI 라벨 추천 동작
- [ ] 체크박스 다중 선택 + 선택 카운트 표시
- [ ] "선택 승인" 버튼: 선택한 청크만 일괄 승인
- [ ] "전체 승인" 버튼: 전체 대기중 청크 일괄 승인
- [ ] "전체 승인+라벨" 버튼: 전체 승인 -> 관리 탭 자동 전환
- [ ] 생성 탭에서 청크 생성 후 승인 탭 자동 리프레시
- [ ] `kw-tab-approval.js` 200줄 이내
- [ ] innerHTML 사용 시 escapeHtml 적용
- [ ] 콘솔 에러 0건

---

## 5. 리스크

| 리스크 | 대응 |
|--------|------|
| ChunkApprovalManager DOM ID 하드코딩 | config 객체로 모든 ID를 주입 (이미 지원됨) |
| 기존 `window.approvalManager` 참조 충돌 | 통합 페이지에서만 할당, 기존 페이지는 자체 할당 유지 |
| 다중 선택 시 페이지 전환 후 선택 초기화 | 페이지 전환 시 `selectedChunkIds.clear()` 명시 호출 |

---

**문서 관리**: Phase 19-4, Task 19-4-3, 작성일 2026-02-22
