# Task 19-4-4: 관리 탭 통합

> **도메인**: [FE]
> **담당**: frontend-dev
> **의존성**: 19-4-1 (스캐폴딩 완료 필요)
> **예상 줄 수**: JS ~150, HTML 마크업 ~80

---

## 1. 목표

기존 `/admin/chunk-labels` 페이지의 라벨 관리 기능을 통합 페이지의 "관리" 탭으로 이식한다. 다중 선택 + 일괄 라벨 추가/제거 기능을 추가한다.

---

## 2. 구현 단계

### 2.1 ManageTab 클래스 생성

**파일**: `web/public/js/admin/kw-tab-manage.js` (신규, ~150줄)

기존 `LabelManager` 클래스를 **직접 재사용** (복사하지 않음):

```javascript
class ManageTab {
  constructor() {
    this.workflow = null;
    this.container = null;
    this.manager = null;  // LabelManager 인스턴스
    this.selectedChunkIds = new Set();  // 다중 선택용
  }

  init(container, workflow) {
    this.container = container;
    this.workflow = workflow;

    this.manager = new LabelManager({
      enablePagination: true,
      enableLabelsPagination: false,
      chunkListId: 'kw-manage-chunk-list',
      chunkSearchInputId: 'kw-manage-chunk-search',
      currentChunkInfoId: 'kw-manage-current-chunk-info',
      currentLabelsId: 'kw-manage-current-labels',
      chunkLabelsSectionId: 'kw-manage-labels-section',
      chunkContentId: 'kw-manage-chunk-content',
      labelPickerListId: 'kw-manage-label-picker-list',
      aiSuggestionsContainerId: 'kw-manage-ai-suggestions',
      aiSuggestStatusId: 'kw-manage-ai-status',
      aiSuggestBtnId: 'kw-manage-btn-ai-suggest',
      aiNewKeywordsContainerId: 'kw-manage-ai-new-keywords',
      aiNewKeywordsWrapId: 'kw-manage-ai-new-keywords-wrap',
      chunkPaginationHideWhenEmpty: false,
      onLabelChange: () => {},
      onChunkChange: () => {},
    });

    window.labelManager = this.manager;

    this.bindEvents();
  }

  activate() {
    this.manager.loadChunks();
    this.manager.loadLabelOptions();
  }

  deactivate() { /* no-op */ }

  refresh() {
    this.manager.loadChunks();
    this.manager.loadLabelOptions();
  }

  onTabEvent(fromTab, event) {
    if (event.type === 'chunks_approved' || event.type === 'chunks_created') {
      this.refresh();
    }
  }

  // 다중 선택 관련
  toggleChunkSelection(chunkId) { ... }
  selectAllVisible() { ... }
  deselectAll() { ... }
  updateBulkToolbar() { ... }

  // 일괄 라벨 추가 (FE 루프)
  async batchAddLabelsToSelected() {
    const chunkIds = Array.from(this.selectedChunkIds);
    const labelIds = Array.from(this.manager.selectedLabelIdsForAdd);
    if (chunkIds.length === 0 || labelIds.length === 0) {
      showError('청크와 라벨을 모두 선택하세요.');
      return;
    }

    let totalSuccess = 0;
    let totalFail = 0;
    const statusEl = this.container.querySelector('#kw-manage-bulk-status');

    for (let i = 0; i < chunkIds.length; i++) {
      if (statusEl) statusEl.textContent = `${i + 1}/${chunkIds.length} 처리 중...`;
      const { success, fail } = await batchAddLabelsToChunkApi(chunkIds[i], labelIds);
      totalSuccess += success;
      totalFail += fail;
    }

    if (statusEl) statusEl.textContent = '';
    showSuccess(`${totalSuccess}개 라벨 추가 완료` + (totalFail > 0 ? `, ${totalFail}개 실패` : ''));
    this.manager.selectedLabelIdsForAdd.clear();
    this.selectedChunkIds.clear();
    this.refresh();
  }

  // 일괄 라벨 제거
  async batchRemoveLabelFromSelected(labelId) { ... }

  bindEvents() { ... }
}
```

### 2.2 다중 선택 기능

기존 `LabelManager.displayChunks()`는 단일 선택만 지원. 접근 A와 동일하게 DOM 후처리로 체크박스 삽입:

```javascript
afterDisplayChunks() {
  const items = this.container.querySelectorAll('.chunk-item-select');
  items.forEach(item => {
    const chunkId = /* item에서 추출 */;
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.className = 'kw-bulk-check';
    checkbox.checked = this.selectedChunkIds.has(chunkId);
    checkbox.addEventListener('change', (e) => {
      e.stopPropagation();
      this.toggleChunkSelection(chunkId);
    });
    item.prepend(checkbox);
  });
}
```

### 2.3 일괄 라벨 추가/제거 UI

일괄 작업 시 진행 상태 표시:
```
[2/5 처리 중...] 일괄 라벨 추가 진행
```

일괄 제거는 현재 선택된 청크 중 특정 라벨을 가진 것들에서 해당 라벨 제거:
```javascript
async batchRemoveLabelFromSelected(labelId) {
  const chunkIds = Array.from(this.selectedChunkIds);
  let success = 0;
  for (const chunkId of chunkIds) {
    try {
      await removeChunkLabelApi(chunkId, labelId);
      success++;
    } catch (e) { /* skip */ }
  }
  showSuccess(`${success}개 청크에서 라벨 제거 완료`);
  this.refresh();
}
```

### 2.4 HTML 마크업

**파일**: `web/src/pages/admin/knowledge-workflow.html`

`#tab-manage` 영역 (기존 chunk-labels.html 구조 참고):
```html
<div class="kw-manage-layout">
  <!-- 좌측: 청크 목록 -->
  <div class="kw-manage-left">
    <h3>청크 목록</h3>
    <div class="form-group">
      <input type="text" id="kw-manage-chunk-search" placeholder="청크 검색..." />
    </div>
    <div class="kw-bulk-toolbar" id="kw-manage-bulk-toolbar" style="display:none">
      <input type="checkbox" id="kw-manage-select-all" /> 전체 선택
      <span id="kw-manage-selected-count">0개 선택</span>
      <button class="btn btn-primary btn-small" id="kw-manage-btn-bulk-add-labels">선택 청크에 라벨 추가</button>
      <span id="kw-manage-bulk-status"></span>
    </div>
    <div id="kw-manage-chunk-list" class="chunk-list">
      <div class="loading">청크 목록을 불러오는 중...</div>
    </div>
    <div id="kw-manage-pagination" class="chunk-labels-pagination" style="display:none">
      <!-- 페이지네이션 -->
    </div>
  </div>
  <!-- 우측: 라벨 관리 -->
  <div class="kw-manage-right">
    <div id="kw-manage-labels-section">
      <h3>선택된 청크</h3>
      <!-- 라벨 피커 -->
      <div class="label-picker-block">
        <h4>라벨 선택</h4>
        <div class="label-picker-row">
          <aside class="label-picker-filter">
            <!-- 라벨 분류 필터 버튼 -->
          </aside>
          <div class="label-picker-main">
            <div class="label-picker-toolbar">
              <!-- 전체선택/유사선택/해제/추가 버튼 -->
            </div>
            <div id="kw-manage-label-picker-list" class="label-picker-list"></div>
          </div>
        </div>
      </div>
      <!-- 청크내 연결된 라벨 -->
      <div class="chunk-linked-labels-block">
        <h4>청크내 연결된 라벨</h4>
        <div id="kw-manage-current-labels" class="current-labels-wrap"></div>
      </div>
      <!-- 청크 내용 + AI 추천 -->
      <div class="chunk-content-block">
        <h4>청크 내용</h4>
        <div class="chunk-content-ai-row">
          <button class="btn btn-primary btn-small" id="kw-manage-btn-ai-suggest">AI 키워드 라벨 추천</button>
          <span id="kw-manage-ai-status"></span>
        </div>
        <div id="kw-manage-ai-suggestions" class="ai-label-suggestions" style="display:none"></div>
        <div id="kw-manage-ai-new-keywords-wrap" class="ai-new-keywords-wrap" style="display:none">
          <h5 class="ai-new-keywords-title">새 키워드</h5>
          <div id="kw-manage-ai-new-keywords" class="ai-new-keywords"></div>
        </div>
        <div id="kw-manage-current-chunk-info" class="chunk-labels-current-info" aria-hidden="true"></div>
        <div id="kw-manage-chunk-content" class="chunk-content-body"></div>
      </div>
    </div>
  </div>
</div>
```

---

## 3. 수정/생성 파일 목록

| 구분 | 파일 | 작업 |
|------|------|------|
| 신규 | `web/public/js/admin/kw-tab-manage.js` | ManageTab 클래스 |
| 수정 | `web/src/pages/admin/knowledge-workflow.html` | #tab-manage 마크업 추가 |

---

## 4. Done Definition

- [ ] 관리 탭 활성화 시 청크 목록 + 라벨 옵션 자동 로드
- [ ] 청크 검색 동작
- [ ] 청크 선택 시 우측에 라벨 관리 패널 표시
- [ ] 라벨 피커: 분류 필터, 전체선택/유사선택/해제
- [ ] 라벨 추가/제거 동작
- [ ] AI 키워드 라벨 추천 동작
- [ ] 새 키워드 라벨 등록 동작
- [ ] 체크박스 다중 선택 + 선택 카운트 표시
- [ ] "선택 청크에 라벨 추가" 일괄 처리 (FE 루프) + 진행 상태 표시
- [ ] 승인 탭에서 청크 승인 후 관리 탭 자동 리프레시
- [ ] `kw-tab-manage.js` 200줄 이내
- [ ] innerHTML 사용 시 escapeHtml 적용
- [ ] 콘솔 에러 0건

---

## 5. 리스크

| 리스크 | 대응 |
|--------|------|
| LabelManager DOM ID 하드코딩 | config 객체로 모든 ID를 주입 (이미 지원됨) |
| 일괄 라벨 추가 시 대량 API 호출 (N청크 x M라벨) | 진행 상태 표시 + 최대 100건 제한 안내 |
| `window.labelManager` 참조 충돌 | 통합 페이지에서만 할당, 기존 페이지는 자체 할당 유지 |
| LabelManager.displayChunks() 후 체크박스 삽입 타이밍 | `loadChunks()` 콜백(onChunkChange)에서 후처리 |

---

**문서 관리**: Phase 19-4, Task 19-4-4, 작성일 2026-02-22
