# Task 19-4-2: 생성 탭 통합

> **도메인**: [FE]
> **담당**: frontend-dev
> **의존성**: 19-4-1 (스캐폴딩 완료 필요)
> **예상 줄 수**: JS ~250, HTML 마크업 ~80

---

## 1. 목표

기존 `/admin/chunk-create` 페이지의 3단계 청크 생성 기능을 통합 페이지의 "생성" 탭으로 이식한다. "빠른 승인" 버튼과 완료 시 탭 자동 전환을 추가한다.

---

## 2. 구현 단계

### 2.1 CreateTab 클래스 생성

**파일**: `web/public/js/admin/kw-tab-create.js` (신규, ~250줄)

기존 `chunk-create.js`(468줄 IIFE)를 클래스 기반으로 재구성:

```javascript
class CreateTab {
  constructor() {
    this.workflow = null;
    this.container = null;
    this.tempChunks = [];
    this.currentStep = 1;
    this.selectedFilePath = '';
    this.selectedFileName = '';
    this.allFileItems = [];
    this.filePage = 1;
    this.FILE_PAGE_SIZE = 15;
  }

  init(container, workflow) { ... }
  activate() { ... }
  deactivate() { ... }
  refresh() { ... }
  onTabEvent(fromTab, event) { ... }

  // 내부 메서드 (기존 로직 이식)
  loadStorageFileList() { ... }
  loadFileContent(filePath, fileName) { ... }
  showStep(step) { ... }
  runSplit() { ... }
  renderTempList() { ... }
  registerSelected() { ... }
  quickApproveAndRegister() { ... }  // 신규: 등록+즉시승인
}
```

핵심 변경점 (기존 대비):
1. IIFE -> 클래스 기반
2. `document.getElementById()` -> `this.container.querySelector()` (탭 스코프 제한)
3. "빠른 승인" 버튼 추가: 등록 성공 후 `batchApproveChunksApi([...ids])` 호출
4. 등록 완료 시 `this.workflow.notifyTabChange('create', { type: 'chunks_created' })` 발행
5. 완료 시 승인 탭 자동 전환: `this.workflow.switchTab('approval')`

### 2.2 HTML 마크업

**파일**: `web/src/pages/admin/knowledge-workflow.html`

`#tab-create` 영역 내에 기존 `chunk-create.html`의 `<div class="admin-panel">` 내부 구조를 이식하되:
- 최상위 컨테이너 ID에 `kw-create-` 접두사 추가 (충돌 방지)
- 3단계 탭/패널 구조 동일 유지
- 3단계 등록 버튼 옆에 "빠른 승인" 버튼 추가

주요 ID 매핑:
| 기존 ID | 통합 페이지 ID |
|---------|---------------|
| `storage-file-list` | `kw-create-file-list` |
| `chunk-source-text` | `kw-create-source-text` |
| `temp-chunk-list` | `kw-create-temp-list` |
| `btn-register-chunks` | `kw-create-btn-register` |
| (신규) | `kw-create-btn-quick-approve` |

### 2.3 "빠른 승인" 로직

```javascript
async quickApproveAndRegister() {
  // 1. 기존 registerSelected() 로직으로 청크 등록
  const createdChunkIds = await this.registerChunksInternal();
  if (createdChunkIds.length === 0) return;

  // 2. 등록된 청크 즉시 일괄 승인
  try {
    await batchApproveChunksApi(createdChunkIds);
    showSuccess(`${createdChunkIds.length}개 청크가 등록 + 승인되었습니다.`);
  } catch (e) {
    showError('등록은 완료, 승인 중 오류: ' + e.message);
  }

  // 3. 관리 탭으로 전환 (라벨 작업 유도)
  this.workflow.switchTab('manage');
}
```

---

## 3. 수정/생성 파일 목록

| 구분 | 파일 | 작업 |
|------|------|------|
| 신규 | `web/public/js/admin/kw-tab-create.js` | CreateTab 클래스 |
| 수정 | `web/src/pages/admin/knowledge-workflow.html` | #tab-create 마크업 추가 |

---

## 4. Done Definition

- [ ] 생성 탭에서 파일 목록 로드 + 페이지네이션 동작
- [ ] 파일 선택 -> 내용 표시 -> 분할 방식 선택 -> 자동 생성
- [ ] 2단계: 분할 청크 목록, 전체 선택/해제, 선택 병합, 헤딩 병합
- [ ] 3단계: 새 문서/기존 문서 선택 + 등록
- [ ] "빠른 승인" 버튼: 등록 + 즉시 승인 + 관리 탭 전환
- [ ] 일반 등록 완료 시 승인 탭 자동 전환
- [ ] 탭 비활성화/재활성화 시 상태 유지
- [ ] `kw-tab-create.js` 250줄 이내
- [ ] innerHTML 사용 시 escapeHtml 적용
- [ ] 콘솔 에러 0건

---

## 5. 리스크

| 리스크 | 대응 |
|--------|------|
| 기존 IIFE에서 클래스 전환 시 this 바인딩 이슈 | 이벤트 리스너에서 화살표 함수 또는 .bind(this) 사용 |
| DOM ID 충돌 (기존 페이지와 동시 로드 시) | kw-create- 접두사로 모든 ID 분리 |
| registerSelected() 반환값 변경 (생성된 chunk ID 필요) | API 응답에서 chunk.id 수집 |

---

**문서 관리**: Phase 19-4, Task 19-4-2, 작성일 2026-02-22
