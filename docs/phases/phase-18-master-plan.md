# Phase 18 Master Plan: 리팩토링 + 트리 구조 UI + Reasoning 리뉴얼

> **상태**: DRAFT v2
> **작성일**: 2026-02-21
> **선행 조건**: Phase 17 체인 완료 (17-1 ~ 17-8)
> **리팩토링 레지스트리**: [refactoring-registry.md](../refactoring/refactoring-registry.md)

---

## 목표

1. **선행 리팩토링** — `labels_handlers.py`(748줄, Lv1) 분리. 18-1에서 수정하는 파일이므로 필수 선행
2. **키워드 그룹 트리 구조 UI** — 별도 탭 분리 + LLM 추천 복구 + 연관 키워드 + 하단 액션바
3. **지식 구조 UI** — 문서 폴더 트리 + 통합 지식 트리(Project→폴더→문서→청크→라벨)
4. **Reasoning 페이지 리뉴얼** — 순차 진행 플로우 + 예시 화면 삽입 + CSS 재구성(1,204줄 핫스팟)
5. **검색 품질 + 관계 추천** — 모드 간 일관성 + 관계 알고리즘 고도화

---

## Phase 체인 구조

| Phase | 내용 | 예상 Task | 의존성 |
|-------|------|:---------:|--------|
| **18-0** | 선행 리팩토링 (Lv1) | 3 | 독립 (최우선) |
| **18-1** | 키워드 그룹 트리 구조 UI | 7 | 18-0 |
| **18-2** | 지식 구조 UI (폴더 트리 + 통합 트리) | 5 | 독립 (18-1 병행 가능) |
| **18-3** | Reasoning 페이지 리뉴얼 | 6 | 독립 (18-1/18-2 병행 가능) |
| **18-4** | 검색 품질 + 관계 추천 고도화 | 5 | 독립 |

```
18-0 (리팩토링) ──→ 18-1 (키워드 그룹)
18-2 (지식 구조)           ── 독립
18-3 (Reasoning 리뉴얼)    ── 독립
18-4 (검색 + 관계)         ── 독립
```

---

## Phase 18-0: 선행 리팩토링 (Lv1)

**근거**: `labels_handlers.py`(748줄)를 18-1에서 수정해야 하므로 리팩토링 먼저 (REFACTOR-2 우선순위 규정)

### 현재 구조 (AS-IS)

```
backend/routers/knowledge/labels_handlers.py (748줄)
  ├── CRUD 핸들러 (create/read/update/delete label)   ~250줄
  ├── 트리 API 핸들러 (tree/move/breadcrumb)           ~280줄
  └── 추천 핸들러 (suggest-parent, suggest-keywords)    ~180줄
```

### 목표 구조 (TO-BE)

```
backend/routers/knowledge/
  ├── labels_handlers.py       → labels_crud.py (~250줄, 독립)
  ├──                          → labels_tree.py (~280줄, 독립)
  └──                          → labels_suggest.py (~180줄, 참조:labels_tree)
```

| Task | 내용 | 도메인 |
|------|------|--------|
| 18-0-1 | `labels_crud.py` 분리 — Label CRUD 핸들러 추출 | [BE] |
| 18-0-2 | `labels_tree.py` 분리 — 트리 조회/이동/Breadcrumb 추출 | [BE] |
| 18-0-3 | `labels_suggest.py` 분리 — AI 추천 핸들러 추출 + import 정리 + 테스트 통과 검증 | [BE] |

---

## Phase 18-1: 키워드 그룹 트리 구조 UI

### 18-1-A: 트리 구조 연결 — 별도 탭 구성

| Task | 내용 | 도메인 |
|------|------|--------|
| 18-1-1 | 그룹 관리 페이지 탭 UI (목록 탭 / 트리 연결 탭) | [FE] |
| 18-1-2 | 트리 연결 탭: 부모-자식 연결 관리 UI + D&D 계층 편집 | [FE] |

**트리 연결 탭 UI**:
```
┌─────────────────────────────────────────────────┐
│ [목록 탭]  [트리 연결 탭]                          │
├─────────────────────────────────────────────────┤
│  전체 키워드 그룹 트리                              │
│  ├── 📁 AI 키워드 그룹                            │
│  │    ├── 📁 머신러닝                              │
│  │    │    ├── 분류                                │
│  │    │    └── 회귀                                │
│  │    └── 📁 딥러닝                                │
│  └── 📁 SI 프로젝트 롤                             │
│       └── ...                                     │
│  ───── D&D로 부모-자식 연결 변경 가능 ─────          │
│  ───── Breadcrumb: AI > 머신러닝 > 분류 ─────       │
└─────────────────────────────────────────────────┘
```

### 18-1-B: 키워드 추천 LLM 복구 + 연관 키워드

| Task | 내용 | 도메인 |
|------|------|--------|
| 18-1-3 | 키워드 목록 상단에 LLM 추천 버튼 복구 | [FE] |
| 18-1-4 | 연관 키워드 섹션 (유사도 % 표시 + 조회/추가 UI) | [BE][FE] |
| 18-1-5 | 연관 키워드 API (ILIKE + Qdrant 유사도 결합 → 상위 20개) | [BE] |
| 18-1-6 | 하단 액션바 통합 (수정/삭제/저장 일원화) | [FE] |
| 18-1-7 | 키워드 그룹 CSS 정리 (admin-groups.css 613줄 모니터링) | [FE] |

**키워드 목록 칸 UI**:
```
┌─────────────────────────────────────────┐
│ 키워드 목록                [🤖 LLM 추천] │  ← 추천 버튼 복구
├─────────────────────────────────────────┤
│ § 그룹 내 키워드                          │
│  ☑ 분류 / ☑ 회귀 / ☑ 신경망              │
├─────────────────────────────────────────┤
│ § 연관 키워드 추천 (그룹 외)               │  ← 유사도 % 표시
│  🔍 키워드 검색 [___________] [조회]       │
│  ○ 딥러닝 (87%)  ○ 트랜스포머 (82%)       │
│  ○ CNN (76%)     ○ RNN (71%)             │
│  ... (최대 20개)                          │
├─────────────────────────────────────────┤
│ [수정] [삭제] [저장]                       │  ← 하단 액션바
└─────────────────────────────────────────┘
```

---

## Phase 18-2: 지식 구조 UI

### 현재 구조 (AS-IS)

```
Project (프로젝트)         ← 플랫 목록
 └── Document (문서)       ← 플랫 목록 (file_path만 존재)
      └── Chunk (청크)     ← 문서 내 순서(chunk_index)만
           ├── Label        ← ✅ 트리 구현 완료 (Phase 17-8)
           └── Relation     ← 플랫 엣지 목록
```

### 목표 구조 (TO-BE)

```
Project
 └── 📁 폴더 (file_path 파싱)
      └── 📄 Document
           └── 📎 Chunk
                ├── 🏷️ Label (트리)
                └── 🔗 Relation
```

| Task | 내용 | 도메인 |
|------|------|--------|
| 18-2-1 | Document 폴더 계층 API (file_path 기반 가상 트리 생성) | [BE] |
| 18-2-2 | 폴더 트리뷰 UI 컴포넌트 (접기/펼치기 + 파일 클릭) | [FE] |
| 18-2-3 | 통합 지식 트리 API (Project/폴더/Document/Chunk 계층) | [BE] |
| 18-2-4 | 통합 트리뷰 페이지 또는 사이드 패널 UI | [FE] |
| 18-2-5 | Breadcrumb 전역 네비게이션 (Project → 폴더 → 문서 → 청크) | [FE] |

**통합 지식 트리 UI**:
```
┌─────────────────────────────────────────┐
│ 🔍 검색 [___________]                    │
├─────────────────────────────────────────┤
│ 📁 PAB 프로젝트                          │
│  ├── 📁 backend/                         │
│  │    ├── 📄 labels.py                   │
│  │    │    ├── 📎 chunk#1 "라벨 생성..."   │
│  │    │    └── 📎 chunk#2 "라벨 조회..."   │
│  │    └── 📄 search.py                   │
│  └── 📁 docs/                            │
│       └── 📄 설계서.md                    │
├─────────────────────────────────────────┤
│ Breadcrumb: PAB > backend > labels.py    │
└─────────────────────────────────────────┘
```

**기술 검토**: DB 스키마 변경 최소화 — `file_path` 파싱으로 가상 트리 생성 우선

---

## Phase 18-3: Reasoning 페이지 리뉴얼

### 현재 상태 (AS-IS)

```
JS: 9개 파일 (합산 2,229줄)
CSS: reason.css(607줄) + reason-sections.css(597줄) = 1,204줄 ← Lv2 핫스팟
     + reason-advanced.css(486줄)
4개 모드: 설계설명 / 리스크 / 다음단계 / 히스토리
SSE 스트리밍으로 실시간 진행
```

**현재 문제점**:
1. 결과가 한 번에 표시됨 — 순차적 진행 과정이 보이지 않음
2. 모드별 예시 화면이 없어 사용자가 어떤 결과를 기대해야 하는지 모름
3. CSS 1,204줄 핫스팟 — 리뉴얼 시 증가하면 Lv2 확정

### 목표 (TO-BE)

**핵심 변경: 순차 진행 플로우**

사용자가 질문을 입력하면 결과가 **단계별로 순차 표시**되는 UX:

```
┌─────────────────────────────────────────────────┐
│ Reasoning 질의                                    │
│                                                   │
│ [질문 입력]  [모드 선택 ▼]  [▶ 시작]               │
└─────────────────────────────────────────────────┘
         │
         ▼
┌─ Step 1: 컨텍스트 수집 ────────────────────────────┐
│ ✅ 관련 문서 3건 수집 완료                            │
│  📄 labels.py (score: 0.92)                         │
│  📄 search.py (score: 0.87)                         │
│  📄 설계서.md (score: 0.81)                          │
│                                              [펼치기]│
└─────────────────────────────────────────────────────┘
         │
         ▼
┌─ Step 2: 분석 중 ──────────────────────────────────┐
│ ⏳ LLM 분석 진행 중...                               │
│ ████████████░░░░░░░░ 60%                            │
│                                                     │
│ 💡 중간 결과 미리보기:                                │
│ "라벨 시스템은 트리 구조로 설계되어..."                  │
└─────────────────────────────────────────────────────┘
         │
         ▼
┌─ Step 3: 결과 ─────────────────────────────────────┐
│                                                     │
│ § 답변                                              │
│ ─────────────────────────────────                   │
│ (LLM 응답 스트리밍)                                  │
│                                                     │
│ § 시각화 (모드별)                                     │
│ ┌──────────────────────┐                            │
│ │ [Mermaid/Chart.js]   │                            │
│ └──────────────────────┘                            │
│                                                     │
│ § 인사이트                                           │
│  [관련 청크] [추천 질문] [추천 라벨] [더 탐색]          │
└─────────────────────────────────────────────────────┘
         │
         ▼
┌─ Step 4: 후속 작업 ───────────────────────────────┐
│ [💬 이어서 질문]  [📥 PDF]  [🔗 공유]  [💾 저장]      │
└─────────────────────────────────────────────────────┘
```

**모드별 예시 화면 삽입**:

모드 선택 시 해당 모드의 예시 결과를 미리 보여주어 사용자가 기대값을 가지도록 함:

```
┌─ 모드 선택 ─────────────────────────────────────────┐
│                                                     │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐
│  │ 🏗️ 설계   │  │ ⚠️ 리스크  │  │ 🚀 다음   │  │ 📜 히스토리│
│  │  설명     │  │  분석     │  │  단계     │  │  추적     │
│  └───────────┘  └───────────┘  └───────────┘  └───────────┘
│                                                     │
│  ── 선택 시 예시 미리보기 ──                            │
│                                                     │
│  📋 설계 설명 모드 예시:                               │
│  ┌─────────────────────────────────────────┐        │
│  │ Q: "라벨 시스템의 트리 구조는?"            │        │
│  │                                         │        │
│  │ 📊 구조 다이어그램 (Mermaid)              │        │
│  │ 📝 설계 배경 + 결정 사유                  │        │
│  │ 🔗 관련 문서 참조                         │        │
│  └─────────────────────────────────────────┘        │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### Task 구조

| Task | 내용 | 도메인 |
|------|------|--------|
| 18-3-1 | 순차 진행 Step UI 컴포넌트 (Step 1~4 프레임) | [FE] |
| 18-3-2 | SSE 이벤트 → Step 전환 연동 (progress 이벤트 매핑) | [FE] |
| 18-3-3 | 모드 선택 시 예시 화면 삽입 (4개 모드 × 예시 1건씩) | [FE] |
| 18-3-4 | CSS 재구성 — reason.css + reason-sections.css 기능별 분리 | [FE] |
| 18-3-5 | Step 2 중간 결과 미리보기 (스트리밍 chunk 실시간 표시) | [FE][BE] |
| 18-3-6 | 세션 스레드 UI 개선 (Step 4 후속 작업 영역 통합) | [FE] |

### CSS 재구성 계획 (18-3-4)

현재 핫스팟 해소를 위한 CSS 분리:

```
현재:
  reason.css (607줄)           ← 테마 + 폼 + 결과 + 버튼 + 접근성 혼재
  reason-sections.css (597줄)  ← 추천 + 세션 + 히스토리 + 모달 혼재

TO-BE:
  reason-base.css (~200줄)      ← CSS 변수, 테마, 접근성
  reason-form.css (~150줄)      ← 입력 폼, 모드 선택
  reason-steps.css (~200줄)     ← Step 1~4 순차 진행 레이아웃 (신규)
  reason-results.css (~200줄)   ← 결과 표시, 시각화, 탭
  reason-actions.css (~100줄)   ← 세션, 히스토리, 모달, 후속 작업
  reason-advanced.css (유지)    ← Mermaid, 리스크 매트릭스 등 모드별 시각화
```

### 순차 진행 Flow (상세)

```
사용자: 질문 입력 + 모드 선택 + [시작]
  │
  ▼
┌─ SSE 연결 ──────────────────────────────────┐
│ POST /api/reason/stream                      │
└──────────────────────────────────────────────┘
  │
  ├── event: progress (stage=1) ──→ Step 1 활성화: "컨텍스트 수집 중"
  │     └── event: chunk_collected ──→ 수집된 청크 실시간 표시
  │
  ├── event: progress (stage=2) ──→ Step 1 완료 체크 ✅
  │                                  Step 2 활성화: "분석 중"
  │     └── event: answer (partial) ──→ 중간 결과 미리보기 스트리밍
  │
  ├── event: progress (stage=3) ──→ Step 2 완료 체크 ✅
  │                                  Step 3 활성화: "결과"
  │     ├── event: answer (final) ──→ 전체 답변 표시
  │     ├── event: visualization ──→ 모드별 시각화 렌더링
  │     └── event: recommendations ──→ 인사이트 탭 표시
  │
  └── event: complete ──→ Step 3 완료 체크 ✅
                           Step 4 표시: 후속 작업 버튼
```

---

## Phase 18-4: 검색 품질 + 관계 추천 고도화

| Task | 내용 | 도메인 |
|------|------|--------|
| 18-4-1 | 시맨틱 검색에 status 필터 적용 (Qdrant payload filter) | [BE] |
| 18-4-2 | 검색 결과 UI 차별화 (모드별 배지 + 점수 의미 표시) | [FE] |
| 18-4-3 | 검색 결과 snippet 하이라이트 + 컨텍스트 확장 | [FS] |
| 18-4-4 | Qdrant point ID 기반 cross-document 관계 추천 | [BE] |
| 18-4-5 | 관계 타입 자동 분류 (similar/prerequisite/extends) + 추천 UI 리디자인 | [BE][FE] |

---

## 마일스톤

| 마일스톤 | 내용 | 포함 Phase |
|---------|------|-----------|
| **M0** | 선행 리팩토링 완료 | 18-0 |
| **M1** | 키워드 그룹 트리 탭 + 추천 UX | 18-1 |
| **M2** | 지식 구조 통합 트리 | 18-2 |
| **M3** | Reasoning 리뉴얼 | 18-3 |
| **M4** | 검색 + 관계 품질 | 18-4 |

---

## 기술 검토 사항

### 리팩토링 (18-0)
- `labels_handlers.py` 분리 후 `labels.py` 라우터의 import 경로 수정 필수
- 기존 테스트 전체 통과 확인 후 다음 Phase 진행
- 리팩토링 레지스트리 해소 이력 기재

### 키워드 그룹 (18-1)
- 기존 `keyword-group-treeview.js` 재활용 (Phase 17-8)
- LLM 추천: `handle_suggest_keywords` (suggestions.py) 복구 + 버튼 위치 이동
- 연관 키워드 API: ILIKE + Qdrant 유사도 결합 → 상위 20개
- `admin-groups.css`(613줄) 모니터링 — 추가 시 500줄 초과 관리

### 지식 구조 (18-2)
- 폴더 트리: `file_path` 파싱 → 가상 트리 (DB 스키마 변경 없음)
- 통합 트리: CTE 재귀 쿼리 확장 (기존 Label 트리 패턴 재활용)

### Reasoning 리뉴얼 (18-3)
- 기존 SSE 이벤트 구조 유지, FE Step UI만 추가
- BE 변경 최소화 — progress stage 번호가 이미 존재
- CSS 분리 시 `reason-advanced.css`(486줄)는 유지 (모드별 시각화 전용)
- 예시 화면 데이터: 정적 JSON 또는 하드코딩 (API 불필요)

### 검색 + 관계 (18-4)
- Qdrant payload에 status 필드 존재 여부 확인 필요
- 없으면 임베딩 재생성 시 status 포함하도록 파이프라인 수정
- cross-document 관계 추천: `qdrant_client.search(vector=chunk_vector)` 직접 호출

---

## 참조

- [Phase 17 Chain](phase-chain-17.md)
- [리팩토링 규정](../refactoring/refactoring-rules.md)
- [리팩토링 레지스트리](../refactoring/refactoring-registry.md)
- [SSOT Workflow §10](../SSOT/renewal/iterations/4th/3-workflow.md#10-코드-유지관리-리팩토링)
