# AI 자동화 고도화 운영 가이드 (Phase 16 적용)

**작성일**: 2026-02-17
**범위**: Phase 16-1~16-3 개선사항 기반 운영 설정
**대상**: 80개 이상 파일 처리 시 배치·성능·모니터링·장애 대응

---

## 1. 개요

### 1.1 Phase 16 적용 개선사항

| Phase | 개선 내용 | 효과 |
|-------|----------|------|
| **16-1** | SSE 세부 진행률·ETA·Heartbeat·재연결·DB 트랜잭션 분할 | 사용자 인지 개선, 연결 안정성 향상 |
| **16-2** | Qdrant 배치 임베딩·LLM 묶음 호출·문서 배치 분할·라벨 역인덱스 | 80파일 기준 ~15분 (기존 ~100분 대비 85% 단축) |
| **16-3** | 파일별 완료 즉시 반영(doc_result)·Virtual Scroll (96% DOM 절감) | UX 응답성, 대용량 리스트 렌더링 개선 |

### 1.2 성능 개선 요약 (80파일 기준)

| 지표 | 개선 전 | 개선 후 | 개선율 |
|------|:------:|:------:|:-----:|
| 총 소요 시간 | ~100분 | ~15분 | 85% |
| 메모리 피크 | ~500MB | ~200MB | 60% |
| Ollama 호출 수 | ~960회 (개별) | ~96~192회 (묶음) | 80~90% |
| Qdrant 호출 수 | ~960회 (개별) | ~20회 (배치) | 98% |
| DB 트랜잭션 | 1개 (전체) | 6개 (단계별) | 안정성 향상 |

---

## 2. 배치 및 성능 설정

### 2.1 주요 설정 파라미터

| 설정 | 위치 | 기본값 | 권장 범위 | 설명 |
|------|------|:------:|:---------:|------|
| `QDRANT_BATCH_SIZE` | config / .env | 50 | 30~100 | Qdrant upsert 배치 크기 |
| `LLM_BUNDLE_SIZE` | config / .env | 5 | 3~15 | LLM 키워드 추출 묶음 청크 수 |
| `DOC_BATCH_SIZE` | config / .env | 20 | 10~50 | 자동 배치 분할 문서 수 |
| `SSE_HEARTBEAT_INTERVAL` | config / .env | 0.5 | 0.5~5.0 | SSE Heartbeat 간격 (초) |
| `SSE_RECONNECT_TIMEOUT` | config / .env | 30 | 15~60 | SSE 재연결 타임아웃 (초) |

### 2.2 설정 트레이드오프

| 파라미터 | 값 증가 시 장점 | 값 증가 시 단점 |
|---------|--------------|--------------|
| QDRANT_BATCH_SIZE | 네트워크 왕복 감소 | 단일 요청 메모리·시간 증가 |
| LLM_BUNDLE_SIZE | Ollama 호출 횟수 감소 | 응답 시간 증가, OOM 위험 |
| DOC_BATCH_SIZE | 배치 단계 수 감소 | 배치 실패 시 재작업 범위 증가 |
| SSE_HEARTBEAT_INTERVAL | 네트워크 부하 감소 | 진행률 갱신 지연 |

### 2.3 환경별 권장 설정

| 환경 | QDRANT_BATCH | LLM_BUNDLE | DOC_BATCH | SSE_HB |
|------|:-----------:|:----------:|:---------:|:------:|
| **개발 (10파일 이하)** | 30 | 3 | 10 | 1.0 |
| **일반 (10~50파일)** | 50 | 5 | 20 | 0.5 |
| **대용량 (50~100파일)** | 50 | 10 | 20 | 0.5 |
| **극대용량 (100+파일)** | 100 | 10 | 30 | 1.0 |

---

## 3. Rate Limit 관리

### 3.1 외부 서비스 제약

| 서비스 | 제약 | 현재 대응 | 추가 조치 |
|--------|------|----------|---------|
| **Ollama (로컬 LLM)** | 동시 요청 제한, 모델별 메모리 | LLM_BUNDLE_SIZE로 호출 횟수 제어 | 묶음 크기 감소로 대응 |
| **Qdrant** | HTTP 타임아웃 30초 | QDRANT_BATCH_SIZE로 단일 요청 크기 제어 | 배치 크기 30으로 감소 |
| **PostgreSQL** | 커넥션 풀 10~20 | 단계별 세션 분리 (16-1-3) | 이전 단계 세션 조기 반환 |

### 3.2 내부 제어

| 제어 항목 | 방법 | 위치 |
|----------|------|------|
| 요청 간격 | LLM 호출 사이 대기 (configurable) | ai_workflow_service |
| 배치 간 대기 | DOC_BATCH 간 GC 호출 + 대기 | workflow_extract |
| 동시 작업 제한 | active_tasks 1개 제한 | ai_workflow_state |

---

## 4. 모니터링

### 4.1 주요 모니터링 지표

| 지표 | 정상 범위 | 경고 임계값 | 위험 임계값 |
|------|:--------:|:---------:|:---------:|
| SSE 진행률 갱신 간격 | < 5초 | 10~30초 | > 30초 (재연결) |
| 단일 Ollama 호출 시간 | < 3초 | 3~5초 | > 5초 |
| Qdrant 배치 upsert 시간 | < 5초 | 5~10초 | > 10초 |
| DB 활성 세션 수 | < 5 | 5~8 | > 8 (풀 고갈 위험) |
| 메모리 사용량 | < 200MB | 200~400MB | > 400MB |
| 배치 실패율 | 0% | < 5% | > 5% |

### 4.2 로그 포인트

주요 로그 메시지 패턴:

```
# 배치 진행
INFO  Batch {idx}/{total}: processing {count} docs
INFO  Progress: {pct}% ({current}/{total} chunks), ETA: {eta}s

# 성능 경고
WARN  Qdrant batch {idx} took {elapsed}s (threshold: 10s)
WARN  Ollama response time {elapsed}s exceeds 5s threshold

# 에러
ERROR Extract step failed for doc {doc_id}: {error}
ERROR Qdrant upsert failed for batch {idx}: {error}
```

### 4.3 SSE 이벤트 모니터링

| 이벤트 | 의미 | 주시 포인트 |
|--------|------|-----------|
| `progress` | 진행률 업데이트 | 정기적으로 수신되는지 확인 |
| `heartbeat` | 연결 유지 | 0.5초 간격 수신 확인 |
| `doc_result` | 파일별 완료 | 순차적으로 수신되는지 확인 |
| `error` | 오류 발생 | 즉시 확인 필요 |
| `complete` | 전체 완료 | 최종 결과 확인 |

---

## 5. 리소스 예상치

### 5.1 파일 수별 예상

| 파일 수 | 예상 청크 | 소요 시간 | 메모리 피크 | Ollama 호출 | Qdrant 호출 |
|:------:|:--------:|:--------:|:---------:|:----------:|:----------:|
| 10 | ~120 | ~2분 | ~50MB | ~12~24 | ~3 |
| 30 | ~360 | ~5분 | ~100MB | ~36~72 | ~8 |
| 50 | ~600 | ~8분 | ~150MB | ~60~120 | ~12 |
| 80 | ~960 | ~15분 | ~200MB | ~96~192 | ~20 |
| 100 | ~1,200 | ~20분 | ~250MB | ~120~240 | ~24 |

*예상 기준: 파일당 평균 12청크, LLM_BUNDLE=5~10, QDRANT_BATCH=50*

### 5.2 DB 트랜잭션 단계

| 단계 | 내용 | 세션 수명 |
|:----:|------|---------|
| 1 | 문서 메타데이터 저장 | 배치 시작~완료 |
| 2 | 청크 분할·저장 | 문서별 즉시 커밋 |
| 3 | 임베딩 생성·Qdrant 저장 | 배치별 즉시 커밋 |
| 4 | 키워드 추출 | LLM 묶음별 커밋 |
| 5 | 라벨 매칭·역인덱스 | 문서별 즉시 커밋 |
| 6 | 최종 상태 갱신 | 전체 완료 시 커밋 |

---

## 6. 장애 대응 시나리오

### 6.1 SSE 연결 끊김

| 증상 | 원인 | 대응 |
|------|------|------|
| 진행률 멈춤 (30초+) | 네트워크 불안정 / 서버 부하 | 클라이언트 자동 재연결 (task_id로 재구독) |
| Heartbeat 미수신 | SSE 연결 끊김 | 30초 타임아웃 후 자동 재연결 |
| 재연결 실패 | 서버 다운 / 포트 차단 | 서버 상태 확인 후 수동 재시작 |

### 6.2 Ollama 응답 지연

| 증상 | 원인 | 대응 |
|------|------|------|
| 키워드 추출 지연 (5초+) | 모델 로딩 / 메모리 부족 | LLM_BUNDLE_SIZE 감소 (10→5) |
| 응답 타임아웃 | Ollama 프로세스 다운 | Ollama 재시작, 모델 재로드 확인 |
| OOM 에러 | 묶음 크기 과대 | LLM_BUNDLE_SIZE 3으로 감소 |

### 6.3 Qdrant 배치 실패

| 증상 | 원인 | 대응 |
|------|------|------|
| upsert 타임아웃 (10초+) | 배치 크기 과대 / 디스크 I/O | QDRANT_BATCH_SIZE 30으로 감소 |
| Connection refused | Qdrant 서비스 다운 | 서비스 재시작: `docker restart qdrant` |
| 부분 실패 | 네트워크 지터 | 해당 배치만 자동 재시도 (3회) |

### 6.4 DB 커넥션 고갈

| 증상 | 원인 | 대응 |
|------|------|------|
| 새 세션 생성 불가 | 이전 세션 미반환 | 단계별 세션 분리 확인 (16-1-3) |
| 쿼리 타임아웃 | 장기 트랜잭션 홀드 | 활성 세션 모니터링, 강제 종료 검토 |
| 풀 크기 부족 | 동시 요청 증가 | `POOL_SIZE` 20→30 증가 |

### 6.5 메모리 누수

| 증상 | 원인 | 대응 |
|------|------|------|
| 배치 후 메모리 미해제 | 대형 객체 참조 유지 | 배치 간 `gc.collect()` 강제 실행 |
| 점진적 메모리 증가 | 캐시 무한 성장 | 캐시 TTL·크기 제한 확인 |

---

## 7. 성능 튜닝 체크리스트

### 7.1 초기 세팅

- [ ] Qdrant 배치 크기 설정 (기본 50, 메모리 상황에 따라 조정)
- [ ] LLM 묶음 크기 설정 (기본 5, Ollama 응답 시간에 따라 조정)
- [ ] 문서 배치 크기 설정 (기본 20, 총 파일 수에 따라 조정)
- [ ] SSE Heartbeat 간격 설정 (기본 0.5초)
- [ ] DB 커넥션 풀 크기 확인 (기본 10~20)

### 7.2 운영 중 모니터링

- [ ] SSE 진행률 정상 갱신 확인
- [ ] Ollama 응답 시간 < 5초 유지
- [ ] Qdrant 배치 시간 < 10초 유지
- [ ] DB 활성 세션 < 8 유지
- [ ] 메모리 사용량 < 400MB 유지

### 7.3 대용량 처리 최적화

- [ ] 100+ 파일 시 DOC_BATCH_SIZE 30으로 증가
- [ ] QDRANT_BATCH_SIZE 100으로 증가 (네트워크 양호 시)
- [ ] LLM_BUNDLE_SIZE 10으로 증가 (Ollama 안정 시)
- [ ] SSE_HEARTBEAT_INTERVAL 1.0으로 완화 (네트워크 부하 감소)

---

## 8. 참조

| 문서 | 위치 |
|------|------|
| AI 자동화 리스크 분석 | `docs/planning/260217-1600-AI자동화기능-리스크분석.md` |
| Phase 16 마스터 플랜 | `docs/phases/phase-16-master-plan.md` |
| Phase 16-1 완료 보고 | `docs/phases/phase-16-1/` |
| Phase 16-2 완료 보고 | `docs/phases/phase-16-2/` |
| Phase 16-3 완료 보고 | `docs/phases/phase-16-3/` |
