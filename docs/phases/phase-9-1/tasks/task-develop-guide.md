# Phase 9-1 개발 진행 가이드

**Phase**: 9-1 보안 강화 (Security Enhancement)
**전체 예상 작업량**: 4일
**Task 수**: 4개

---

## 개발 시작 전 필수 확인

### 1. 프로젝트 구조 파악
```
backend/
├── middleware/          # 미들웨어 (9-1 주요 작업 위치)
│   ├── auth.py         # 인증 미들웨어 (신규)
│   ├── cors.py         # CORS 미들웨어 (신규/수정)
│   └── rate_limit.py   # Rate Limiting (신규)
├── routers/
│   └── auth/           # 인증 라우터 (신규)
│       ├── __init__.py
│       └── auth.py
├── config.py           # 설정 파일 (수정)
├── main.py             # 미들웨어 등록 (수정)
└── .env.example        # 환경변수 예시 (수정)
```

### 2. 핵심 기존 코드 확인
개발 전 반드시 아래 파일들의 현재 구조를 확인:

| 파일 | 확인할 내용 |
|------|------------|
| `backend/config.py` | 현재 설정 구조, 환경변수 로딩 방식 |
| `backend/main.py` | 현재 미들웨어 등록 방식, 라우터 구조 |
| `.env` / `.env.example` | 현재 환경변수 항목 |
| `docker-compose.yml` | 환경변수 전달 방식 |

### 3. 환경 확인
```bash
# Docker 서비스 실행 확인
docker-compose ps

# 필요 서비스: backend, postgres, qdrant, ollama
```

---

## Task 개발 순서

```
┌─────────────────────────────────────────────────────────────┐
│                    Phase 9-1 개발 순서                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [1] Task 9-1-2: 환경변수 비밀번호 관리 (0.5일) ★ 최우선    │
│      └── 하드코딩된 비밀번호 환경변수로 이동                │
│           │                                                 │
│           ▼                                                 │
│  [2] Task 9-1-1: API 인증 시스템 (2일)                      │
│      ├── 인증 미들웨어 구현                                 │
│      ├── 인증 라우터 구현                                   │
│      └── 기존 라우터에 인증 적용                            │
│           │                                                 │
│           ▼ (완료 후 병렬 진행 가능)                        │
│  ┌────────┴────────┐                                        │
│  │                 │                                        │
│  ▼                 ▼                                        │
│  [3] Task 9-1-3   [4] Task 9-1-4                           │
│  CORS 설정        Rate Limiting                            │
│  (0.5일)          (1일)                                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Task 목록 및 상세 문서

| 순서 | Task ID | 이름 | 작업량 | 의존성 | 상세 문서 |
|------|---------|------|--------|--------|-----------|
| 1 | 9-1-2 | 환경변수 비밀번호 관리 | 0.5일 | 없음 | [task-9-1-2-env-secrets.md](./task-9-1-2-env-secrets.md) |
| 2 | 9-1-1 | API 인증 시스템 | 2일 | 9-1-2 | [task-9-1-1-api-auth.md](./task-9-1-1-api-auth.md) |
| 3 | 9-1-3 | CORS 설정 | 0.5일 | 없음 | [task-9-1-3-cors.md](./task-9-1-3-cors.md) |
| 4 | 9-1-4 | Rate Limiting | 1일 | 없음 | [task-9-1-4-rate-limit.md](./task-9-1-4-rate-limit.md) |

---

## 파일 변경 총괄

### 신규 생성 파일 (총 6개)

| Task | 파일 경로 | 용도 |
|------|----------|------|
| 9-1-1 | `backend/middleware/auth.py` | 인증 미들웨어 |
| 9-1-1 | `backend/routers/auth/__init__.py` | 인증 라우터 패키지 |
| 9-1-1 | `backend/routers/auth/auth.py` | 인증 API |
| 9-1-3 | `backend/middleware/cors.py` | CORS 미들웨어 (또는 기존 수정) |
| 9-1-4 | `backend/middleware/rate_limit.py` | Rate Limiting |
| 공통 | `tests/test_security.py` | 보안 테스트 |

### 수정 파일 (총 5개)

| Task | 파일 경로 | 수정 내용 |
|------|----------|----------|
| 9-1-2 | `backend/config.py` | 환경변수 로딩 추가/수정 |
| 9-1-2 | `.env.example` | 환경변수 항목 추가 |
| 9-1-2 | `docker-compose.yml` | 환경변수 전달 확인 |
| 9-1-1 | `backend/main.py` | 미들웨어/라우터 등록 |
| 9-1-1 | 기존 라우터들 | 인증 의존성 추가 |

---

## 개발 규칙

### 코드 품질 필수 사항
- [ ] 모든 함수/메서드에 타입 힌트 적용
- [ ] 모든 클래스/함수에 Docstring 작성
- [ ] 에러 발생 시 적절한 HTTP 상태 코드 반환
- [ ] 보안 관련 로깅 (로그인 시도, 실패 등)

### 보안 필수 사항
- [ ] 비밀번호 절대 평문 저장 금지 (해시 사용)
- [ ] 토큰에 민감 정보 포함 금지
- [ ] 환경변수로 비밀 관리
- [ ] 적절한 토큰 만료 시간 설정

### 하위 호환성 필수 사항
- [ ] 인증 적용 전 개발 환경 테스트 가능하도록 설정
- [ ] 인증 제외 엔드포인트 명확히 정의 (health check 등)

### 테스트 필수 사항
- [ ] 인증 성공/실패 테스트
- [ ] 토큰 만료 테스트
- [ ] Rate Limit 초과 테스트
- [ ] CORS 차단 테스트

---

## 개발 시작 프롬프트

### Task 9-1-2 시작 시
```
Phase 9-1의 Task 9-1-2 (환경변수 비밀번호 관리) 개발을 시작합니다.

참조 문서:
- docs/phases/phase-9-1/tasks/task-9-1-2-env-secrets.md

Step 1부터 순차적으로 진행해주세요.
완료 후 todo-list를 업데이트해주세요.
```

### Task 9-1-1 시작 시 (9-1-2 완료 후)
```
Phase 9-1의 Task 9-1-1 (API 인증 시스템) 개발을 시작합니다.

선행 완료: Task 9-1-2
참조 문서:
- docs/phases/phase-9-1/tasks/task-9-1-1-api-auth.md

9-1-2에서 설정한 환경변수를 활용해주세요.
```

### Task 9-1-3 시작 시
```
Phase 9-1의 Task 9-1-3 (CORS 설정) 개발을 시작합니다.

참조 문서:
- docs/phases/phase-9-1/tasks/task-9-1-3-cors.md

개발/프로덕션 환경 분리를 고려해주세요.
```

### Task 9-1-4 시작 시
```
Phase 9-1의 Task 9-1-4 (Rate Limiting) 개발을 시작합니다.

참조 문서:
- docs/phases/phase-9-1/tasks/task-9-1-4-rate-limit.md

API별 적절한 제한 설정을 고려해주세요.
```

---

## Task 완료 체크리스트

### 각 Task 완료 시 확인
- [ ] 모든 Step 구현 완료
- [ ] 단위 테스트 작성 및 통과
- [ ] 기존 테스트 영향 없음
- [ ] 보안 검토 완료
- [ ] todo-list 체크박스 업데이트
- [ ] 작업 로그 기록

### Phase 9-1 전체 완료 시 확인
- [ ] Task 9-1-2 완료 (환경변수)
- [ ] Task 9-1-1 완료 (인증)
- [ ] Task 9-1-3 완료 (CORS)
- [ ] Task 9-1-4 완료 (Rate Limit)
- [ ] 전체 테스트 통과
- [ ] Phase 9-1 todo-list 완료 표시
- [ ] 다음 Phase (9-2) 시작 준비

---

## 문제 해결 가이드

### 인증 토큰 검증 실패
```python
# JWT 시크릿 키 확인
# 토큰 만료 시간 확인
# 토큰 형식 (Bearer) 확인
```

### CORS 에러
```python
# 허용 오리진 목록 확인
# 프리플라이트 요청 처리 확인
# 크레덴셜 설정 확인
```

### Rate Limit 동작 안함
```python
# Redis 연결 확인 (사용 시)
# 키 생성 로직 확인
# 시간 윈도우 설정 확인
```
