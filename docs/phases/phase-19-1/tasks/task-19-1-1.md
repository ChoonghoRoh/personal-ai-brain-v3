# Task 19-1-1: FIX-2 — 3단계 계층 매칭 도입

- **우선순위**: P0 (최우선)
- **의존성**: 없음
- **담당 팀원**: backend-dev
- **상태**: PENDING

## §1 목적

`match_and_score_labels()`의 ILIKE 부분매칭을 3단계 계층 매칭(Tier 1/2/3)으로 교체하여 엉뚱한 라벨 매칭을 방지하고 `new_keywords` 분류를 정상화한다.

## §2 변경 범위

| 파일 | 변경 유형 |
|------|----------|
| `backend/services/reasoning/recommendation_llm.py` L93-154 | 수정 — `match_and_score_labels()` 함수 교체 |

## §3 구현 상세

**현재 문제**: `ILIKE '%keyword%'` 부분매칭 → "화성" 검색 시 "화성시", "경기도화성" 등 오매칭 → `new_keywords` 소멸

**계층 매칭 설계**:

| Tier | 조건 | 신뢰도 | 글자수 제한 |
|------|------|--------|:----------:|
| Tier 1: 정확 매칭 | `func.lower(Label.name) == kw_lower` | base_conf (0.9~0.5) | 모든 키워드 |
| Tier 2: 접두사 매칭 | `Label.name.ilike(f"{kw}%")` | base_conf × 0.85 | 3자 이상 |
| Tier 3: 부분 매칭 | `Label.name.ilike(f"%{kw}%")` | base_conf × 0.7 | 4자 이상 |
| 미매칭 | Tier 1~3 모두 실패 | — | → `new_keywords` |

**글자수별 Tier 적용**:
- 2자 키워드 (IT, AI): Tier 1만 → 정확 매칭 없으면 new_keywords
- 3자 키워드 (화성, 우주): Tier 1 → Tier 2 → 없으면 new_keywords
- 4자+ 키워드: Tier 1 → Tier 2 → Tier 3

**DB 인덱스**: `Label.name`에 인덱스 존재 여부 확인, 없으면 추가 검토

## §4 완료 기준

- [ ] `match_and_score_labels()` 3단계 계층 매칭 구현
- [ ] Tier별 신뢰도 차등 적용 (base_conf, ×0.85, ×0.7)
- [ ] 글자수별 Tier 제한 적용
- [ ] "화성" → 정확 매칭만 (오매칭 방지)
- [ ] "AI" → Tier 1만 시도
- [ ] "딥러닝" → Tier 1 → Tier 2 허용
- [ ] 미매칭 키워드 → new_keywords 정상 분류
- [ ] 기존 테스트 통과
